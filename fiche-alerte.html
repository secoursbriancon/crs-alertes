<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRS Alpes Brian√ßon - Alerte Secours</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{--bg:#243244;--panel:#2f4357;--panel-alt:#3a5064;--ink:#eaf0f6;--muted:#a9b7c9;--accent:#e94560;--accent-2:#0f3460;--border:#41576d;--ok:#2ecc71;--warn:#e74c3c;--info:#3499db;--shadow-light: 0 4px 15px rgba(0,0,0,.2);--shadow-bold: 0 10px 30px rgba(0,0,0,.4);}
        body {font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background: linear-gradient(180deg, #1f2a38 0%, var(--bg) 100%);color: var(--ink);padding: 24px;line-height: 1.4;}
        .container {max-width: 1000px;margin: 0 auto;background: var(--panel);border-radius: 14px;padding: 28px;box-shadow: 0 18px 60px rgba(0,0,0,.35);border: 1px solid rgba(255,255,255,.05);}
        h1 {color: var(--accent);font-size: 28px;text-align: center;margin-bottom: 6px;}
        .subtitle {text-align: center;color: var(--muted);font-size: 14px;margin-bottom: 20px;}
        .alert-header {background: linear-gradient(120deg, var(--accent-2), var(--accent));padding: 14px 16px;border-radius: 10px;margin-bottom: 24px;display: flex;justify-content: space-between;align-items: center;}
        .section {background: var(--panel-alt);padding: 20px;border-radius: 12px;margin-bottom: 18px;border: 1px solid var(--border);}
        .section-title {font-size: 20px;font-weight: 900;color: var(--accent);margin-bottom: 18px;padding-bottom: 5px;border-bottom: 2px solid var(--accent);display: inline-block;text-transform: uppercase;letter-spacing: 1px;}
        .form-row-custom { display: grid; gap: 14px; margin-bottom: 14px; }
        .form-row-requerant-1 { grid-template-columns: 1fr 200px; }
        .form-row-requerant-2 { grid-template-columns: 1fr 1fr; }
        .form-row-intervention { grid-template-columns: 1fr 1fr; }
        .form-row-lieu { grid-template-columns: 1fr 1.2fr 120px; }
        .form-row-victime { grid-template-columns: 140px 110px 0.8fr; }
        .form-row-moyens { grid-template-columns: 1fr 1fr; }
        label {color: var(--muted);font-size: 12px;font-weight: 700;margin-bottom: 6px;text-transform: uppercase;}
        input[type="text"], input[type="number"], input[type="tel"], textarea, select {background: #1b2735;border: 1px solid var(--border);border-radius: 10px;padding: 10px 12px;color: var(--ink);font-size: 14px;width: 100%;position: relative;z-index: 1;pointer-events: auto;cursor: text;}
        input[type="text"]:focus, input[type="number"]:focus, input[type="tel"]:focus, textarea:focus, select:focus {
            z-index: 1000;
            outline: 2px solid var(--info);
        }
        .form-group {display: flex;flex-direction: column;}
        .checkbox-group {display: flex;gap: 15px;align-items: center;margin-top: 10px;}
        .checkbox-label {display: flex;align-items: center;font-size: 14px;font-weight: 500;color: var(--ink);}
        .phone-group {
            display: flex;
            gap: 6px;
            align-items: center;
            width: 100%;
        }
        .phone-group-inner {display: flex;flex-grow: 1;gap: 8px;}
        .phone-group-inner input {flex-grow: 1;}
        .country-code-select {background: #1b2735;border: 1px solid var(--border);border-radius: 10px;padding: 8px 4px;color: var(--ink);font-size: 13px;height: 40px;text-align: center;width: 110px;flex-shrink: 0;}
        .btn-add-phone, .btn-remove-phone {width: 40px;height: 40px;border-radius: 10px;font-size: 20px;font-weight: bold;border: none;cursor: pointer;transition: background 0.2s;box-shadow: var(--shadow-light);color: #fff;flex-shrink: 0;display: flex;justify-content: center;align-items: center;}
        .btn-add-phone {background: var(--ok);}
        .btn-remove-phone {background: var(--warn);}
        
        /* Texte "Autre" cliquable */
        .text-link {
            color: var(--info);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .text-link:hover {
            color: #3498db;
            text-decoration-style: solid;
        }
        
        /* Layout t√©l√©phone responsive */
        
        /* Navigation centr√©e */
        .section-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px dashed var(--border);
            flex-wrap: wrap;
        }
        .nav-actions {
            display: flex;
            gap: 12px;
        }
        
        /* Boutons fl√®ches modernes */
        .btn-arrow {
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--panel-alt);
            color: var(--ink);
            cursor: pointer;
            box-shadow: var(--shadow-light);
            transition: all 0.2s ease;
        }
        .btn-arrow:hover {
            background: var(--accent-2);
            border-color: var(--info);
            transform: translateY(-2px);
            box-shadow: var(--shadow-bold);
        }
        .btn-arrow svg {
            transition: transform 0.2s;
        }
        .btn-arrow:hover svg {
            transform: scale(1.1);
        }
        .btn-return svg {
            transform: rotate(180deg);
        }
        .btn-return:hover svg {
            transform: rotate(180deg) scale(1.1);
        }
        
        /* Champ Autre */
        .autre-field {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Collapsible */
        .collapsible-header {
            cursor: pointer;
            color: var(--info);
            font-weight: 600;
            font-size: 14px;
            padding: 10px 12px;
            background: var(--panel-alt);
            border-radius: 8px;
            transition: all 0.2s;
            user-select: none;
        }
        .collapsible-header:hover {
            background: #3a5570;
        }
        .collapsible-header.active span::before {
            content: "‚ñº ";
        }
        .collapsible-content {
            animation: slideDown 0.3s ease;
        }
        
        /* Bouton Gendloc */
        .btn-gendloc {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-light);
        }
        .btn-gendloc:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-bold);
        }
        .gendloc-status {
            display: inline-flex;
            align-items: center;
            font-size: 13px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .gps-group {display: flex;align-items: center;gap: 2px;margin-top: 5px;}
        .gps-group input {text-align: right;padding: 6px 6px;height: 30px;font-size: 13px;max-width: 45px;flex-grow: 1;}
        #sectionLocalisation input[maxlength="2"] {max-width: 35px;}
        #sectionLocalisation input[maxlength="5"] {max-width: 50px;}
        .gps-group span {font-size: 14px;color: var(--muted);font-weight: 500;}
        .moyens-volants-terrestres {display: flex;gap: 20px;margin-bottom: 10px;}
        .secouristes-grid {display: flex;flex-wrap: wrap;gap: 8px 15px;margin-top: 8px;line-height: 1.2;}
        .btn {border: none;padding: 10px 18px;border-radius: 12px;cursor: pointer;font-size: 14px;font-weight: 800;box-shadow: var(--shadow-light);transition: all 0.2s ease;}
        .btn:hover { box-shadow: var(--shadow-bold); transform: translateY(-2px); }
        .btn-green { background: var(--ok); color: #fff; }
        .btn-red {background: var(--warn);color: #fff;padding: 6px 12px;font-size: 12px;border-radius: 8px;height: 30px;display: flex;align-items: center;}
        .actions { display: flex; gap: 12px; justify-content: center; margin-top: 26px; }
        .section-nav {display: flex;justify-content: flex-end;align-items: center;gap: 20px;margin-top: 12px;padding-top: 12px;border-top: 1px dashed var(--border);}
        .btn-copy {background: var(--info);color: #fff;border: 1px solid var(--info);padding: 10px 18px;border-radius: 12px;font-size: 14px;font-weight: 800;box-shadow: var(--shadow-light);transition: all 0.2s ease;}
        .btn-copy:hover { box-shadow: var(--shadow-bold); transform: translateY(-2px); }
        .nav-actions {display: flex;gap: 10px;}
        .btn-arrow {width: 40px;height: 40px;display: flex;justify-content: center;align-items: center;border-radius: 50%;font-size: 18px;font-weight: 900;color: #fff;border: none;cursor: pointer;box-shadow: var(--shadow-light);transition: all 0.2s ease;}
        .btn-arrow:hover { box-shadow: var(--shadow-bold); transform: scale(1.05); }
        .btn-return { background: var(--warn); }
        .btn-next { background: var(--ok); }
        .section { position: relative; }
        .btn-return-top { position: absolute; top: 12px; right: 12px; z-index: 2; }
        #copyConfirmation, #saveConfirmation {position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);background: rgba(46, 204, 113, 0.95);color: white;padding: 15px 30px;border-radius: 10px;font-weight: bold;font-size: 18px;z-index: 1000;box-shadow: 0 0 20px rgba(0,0,0,0.5);opacity: 0;transition: opacity 0.2s ease;}
        .victim-card {background: #26384a;padding: 14px;border-radius: 12px;margin-bottom: 14px;border: 1px solid var(--border);}
        .blessures-row {display: flex;gap: 14px;align-items: flex-start;}
        .blessures-row select {flex-basis: 65%;min-width: 250px;}
        .blessures-row .form-group {flex-basis: 35%;flex-grow: 1;}
        .blessures-selected {background: #2a3a4b;padding: 8px 12px;border-radius: 10px;margin-bottom: 8px;min-height: 34px;color: var(--ok);font-size: 13px;font-weight: 700;border: 1px solid var(--border);line-height: 1.2;}
        .blessures-selected:empty::before {content: "Aucune blessure s√©lectionn√©e";color: #95a5a6;font-style: italic;font-weight: 500;}
        .victim-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 10px;}
        .status-banner {background: rgba(46, 204, 113, 0.2);border: 1px solid var(--ok);border-radius: 10px;padding: 10px 15px;margin-bottom: 20px;text-align: center;font-size: 14px;}
        .status-banner.error {background: rgba(231, 76, 60, 0.2);border-color: var(--warn);}
        .phone-name-input {
            background: #1b2735;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px 8px;
            color: var(--ink);
            font-size: 12px;
            width: 160px;
            max-width: 160px;
            flex-shrink: 0;
            cursor: text;
        }
        .phone-input {
            width: 135px !important;
            max-width: 135px;
            flex-shrink: 0;
        }
        .blessure-badge{display:inline-block;margin:2px 6px 2px 0;padding:4px 8px;border-radius:10px;background:#1f8f5a;color:#eafff4;font-weight:700;font-size:12px;}
    </style>
</head>
<body>
    <div class="container">
        <div class="status-banner" id="statusBanner" style="display:none;"></div>
        
        <section class="section requerant" id="sectionRequerant" data-section-name="Requ√©rant">
            <div class="section-title">üë§ Requ√©rant</div>
            
            <!-- Ligne 1 : Origine de l'alerte avec Autre int√©gr√© + Activit√© -->
            <div class="form-row-custom" style="grid-template-columns: 250px 250px; gap: 14px; margin-bottom: 14px;">
                <div class="form-group" data-field="Origine de l'alerte">
                    <label>Origine de l'alerte <span class="text-link" id="btnAutreOrigine" style="margin-left: 8px; font-size: 12px;">(Autre)</span></label>
                    <select id="origineAlerte"><option value="">S√©lectionner...</option></select>
                </div>
                
                <div class="form-group" data-field="Activit√©">
                    <label>Activit√© pratiqu√©e</label>
                    <select id="activite"><option value="">S√©lectionner...</option></select>
                </div>
            </div>
            
            <!-- Champ Autre (cach√© par d√©faut) -->
            <div class="form-group autre-field" id="autreOrigineWrap" style="display: none; margin-bottom: 14px;">
                <label>Autre origine (pr√©cisez)</label>
                <input type="text" id="autreOrigineTexte" placeholder="Pr√©cisez l'origine de l'alerte">
            </div>
            
            <!-- T√©l√©phones -->
            <div class="form-group" data-field="T√©l√©phones">
                <label>T√©l√©phone(s) et nom(s)</label>
                <div id="phonesContainer">
                    <div class="phone-group">
                        <select class="country-code-select"></select>
                        <input type="tel" class="phone-input" placeholder="06 12 34 56 78" maxlength="20" inputmode="tel" autocomplete="tel">
                        <input type="text" class="phone-name-input" placeholder="Nom" maxlength="20" style="pointer-events: auto !important; z-index: 10; position: relative;">
                        <button type="button" class="btn-add-phone">+</button>
                    </div>
                </div>
            </div>
            
            <!-- Infos requ√©rant (collapsible) -->
            <div class="form-group collapsible-group" data-field="Infos requ√©rant" style="margin-bottom: 14px;">
                <div class="collapsible-header" id="infosRequerantToggle">
                    <span>‚ñ∂ Informations requ√©rant (optionnel)</span>
                </div>
                <div class="collapsible-content" id="infosRequerantContent" style="display: none; margin-top: 8px;">
                    <input type="text" id="infosRequerant" placeholder="Informations compl√©mentaires">
                </div>
            </div>
            
            <div class="section-nav">
                <button type="button" class="btn-copy" data-section="sectionRequerant">Copier l'alerte</button>
                <div class="nav-actions">
                    <button type="button" class="btn-arrow btn-next" data-target="sectionLocalisation">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
        </section>

        <section class="section localisation" id="sectionLocalisation" data-section-name="Localisation">
            <div class="section-title">üìç Localisation</div>
            <button type="button" class="btn-arrow btn-return btn-return-top" data-target="sectionRequerant">‚Üë</button>
            
            <!-- Ligne d√©partement, commune, altitude -->
            <div class="form-row-custom" style="grid-template-columns: 280px 280px 120px; gap: 14px; margin-bottom: 14px;">
                <div class="form-group" data-field="D√©partement">
                    <label>D√©partement</label>
                    <select id="departement">
                        <option value="05" selected>05 ‚Äì Hautes-Alpes</option>
                        <option value="38">38 ‚Äì Is√®re</option>
                        <option value="73">73 ‚Äì Savoie</option>
                        <option value="04">04 ‚Äì Alpes-de-Haute-Provence</option>
                        <option value="autre">Autre‚Ä¶</option>
                    </select>
                    <div id="departementAutreWrap"></div>
                </div>
                <div class="form-group" data-field="Commune">
                    <label>Commune</label>
                    <input type="text" id="commune" placeholder="Taper pour rechercher..." list="communesList">
                    <datalist id="communesList"></datalist>
                </div>
                <div class="form-group" data-field="Altitude">
                    <label>Altitude (m)</label>
                    <input type="number" id="altitude" class="altitude" placeholder="2500">
                </div>
            </div>
            
            <!-- Lieu exact -->
            <div class="form-group" data-field="Lieu exact">
                <label>Lieu exact</label>
                <input type="text" id="lieuExact" placeholder="Description pr√©cise du lieu" maxlength="100">
            </div>
            
            <!-- Lien Gendloc stylis√© -->
            <div style="margin-top: 10px; margin-bottom: 10px; padding: 8px 12px; background: rgba(52, 152, 219, 0.1); border: 1px solid var(--info); border-radius: 8px; display: inline-block;">
                <span style="color: var(--muted); font-size: 12px; margin-right: 8px;">üåê Ouvrir Gendloc :</span>
                <a href="https://pghm-isere.com/SIG/SIM.php#" target="_blank" style="color: var(--info); font-size: 13px; font-weight: 600; text-decoration: underline;">Acc√©der √† la carte ‚Üí</a>
            </div>
            
            <!-- Bouton Coller goutte Gendloc -->
            <div style="margin-bottom: 14px;">
                <button type="button" class="btn-gendloc" id="btnGendloc">
                    üìç Coller contenu goutte Gendloc
                </button>
                <span class="gendloc-status" id="gendlocStatus" style="display: none; margin-left: 12px; color: var(--ok); font-weight: 600;">
                    ‚úÖ Goutte Gendloc enregistr√©e
                </span>
            </div>
            
            <!-- Cases √† cocher pour pr√©cision de localisation -->
            <div style="margin-top: 14px; margin-bottom: 14px;">
                <label style="display: block; margin-bottom: 8px; color: var(--muted); font-size: 12px; font-weight: 700; text-transform: uppercase;">Pr√©cision de la localisation</label>
                <div class="checkbox-group" style="margin-top: 0;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="geolocExacte" style="margin-right:8px;"> G√©oloc exacte
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="geolocEstimee" style="margin-right:8px;"> Localisation estim√©e
                    </label>
                </div>
            </div>
            <div class="section-nav">
                <button type="button" class="btn-copy" data-section="sectionLocalisation">Copier l'alerte</button>
                <div class="nav-actions">
                    <button type="button" class="btn-arrow btn-next" data-target="sectionVictimes">‚Üì</button>
                </div>
            </div>
        </section>

        <section class="section victimes" id="sectionVictimes" data-section-name="Victime(s)">
            <div class="section-title">üöë Victime(s)</div>
            <button type="button" class="btn-arrow btn-return btn-return-top" data-target="sectionLocalisation">‚Üë</button>
            <div id="victimesContainer">
                <div class="victim-card" id="victim-1">
                    <div class="victim-header"><h4>Victime 1</h4></div>
                    <div class="form-row-custom" style="grid-template-columns: 140px 110px 1fr; gap: 14px; margin-bottom: 14px;">
                        <div class="form-group" data-field="Sexe">
                            <label>Sexe</label>
                            <select class="select-sexe">
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>
                        <div class="form-group" data-field="√Çge">
                            <label>√Çge</label>
                            <input type="number" class="input-age" placeholder="25">
                        </div>
                        <div class="form-group" data-field="Circonstances">
                            <label>Circonstances</label>
                            <select class="select-circonstances"><option value="">S√©lectionner...</option></select>
                        </div>
                    </div>
                    <div class="form-group victim-blessures-group">
                        <label>Blessures (Ctrl pour s√©lection multiple)</label>
                        <div class="blessures-row">
                            <select multiple size="5" id="blessures1" class="select-blessures"></select>
                            <div class="form-group" data-field="Autre blessure" style="flex-grow: 1;">
                                <label style="margin-top: 0;">Autre blessure</label>
                                <input type="text" placeholder="Description libre..." class="blessure-autre-input">
                            </div>
                        </div>
                        <div class="blessures-selected" id="blessuresSelected1" style="margin-top: 8px;"></div>
                    </div>
                    <div class="form-group" data-field="Infos compl√©mentaires" style="margin-top: 15px;">
                        <label>Informations compl√©mentaires</label>
                        <textarea placeholder="Infos suppl√©mentaires..." rows="2" class="victim-infos-comp"></textarea>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-green" id="btnAddVictim">+ Ajouter une victime</button>
            <div class="section-nav">
                <button type="button" class="btn-copy" data-section="sectionVictimes">Copier l'alerte</button>
                <div class="nav-actions">
                    <button type="button" class="btn-arrow btn-next" data-target="sectionMoyens">‚Üì</button>
                </div>
            </div>
        </section>

        <section class="section moyens" id="sectionMoyens" data-section-name="Moyens engag√©s">
            <div class="section-title">üöÅ Moyens engag√©s</div>
            <button type="button" class="btn-arrow btn-return btn-return-top" data-target="sectionVictimes">‚Üë</button>
            <div class="moyens-wrap">
                <div class="moyens-top" data-field="Moyens">
                    <!-- Tableau des moyens -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; padding: 12px; background: rgba(52, 152, 219, 0.05); border: 1px solid var(--border); border-radius: 10px;">
                        <!-- Ligne 1 -->
                        <label class="checkbox-label" style="margin: 0;"><input type="checkbox" id="choucas05" value="CHOUCAS 05"> CHOUCAS&nbsp;05</label>
                        <label class="checkbox-label" style="margin: 0;"><input type="checkbox" id="equipeTerrestre" value="√âquipe terrestre"> √âquipe&nbsp;terrestre</label>
                        
                        <!-- Ligne 2 -->
                        <label class="checkbox-label" style="margin: 0;"><input type="checkbox" id="secoursMed" value="Secours m√©dicalis√©"> Secours m√©dicalis√©</label>
                        <label class="checkbox-label" style="margin: 0;"><input type="checkbox" id="secoursInf" value="Infirmier"> Infirmier</label>
                    </div>
                    
                    <!-- Autre section collapsible -->
                    <div class="collapsible-header" id="autreSectionToggle" style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(231, 76, 60, 0.1); border: 1px solid #e74c3c; border-radius: 10px; margin-bottom: 10px;">
                        <span style="font-weight: 600; color: #e74c3c; font-size: 13px;">‚ö†Ô∏è Autre section (si CHOUCAS 05 indisponible)</span>
                        <span class="arrow" style="margin-left: auto; font-size: 18px; color: #e74c3c;">‚ñº</span>
                    </div>
                    
                    <div id="autreSectionContent" style="display: none;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label>Autre section (Ctrl pour multiple)</label>
                            <select multiple size="3" id="autreSection" style="background: #1b2735; border: 1px solid var(--border); border-radius: 10px; padding: 8px; color: var(--ink); font-size: 14px; width: 100%;">
                                <option>CRS Grenoble</option>
                                <option>CRS Albertville</option>
                                <option>PGHM04</option>
                            </select>
                            <div class="selected-display" id="autreSectionSelected" style="background: #2a3a4b;padding: 8px 12px;border-radius: 10px;margin-top: 8px;min-height: 34px;color: var(--ok);font-size: 13px;font-weight: 700;border: 1px solid var(--border);line-height: 1.2;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-row-custom form-row-moyens" style="margin-top: 14px;">
                <div class="form-group" data-field="M√©t√©o">
                    <label>M√©t√©o (Ctrl pour multiple)</label>
                    <select multiple size="4" id="meteo">
                        <option>Beau</option><option>Nuages</option><option>Brouillard</option>
                        <option>Neigeux</option><option>Vent</option><option>Orage</option>
                    </select>
                    <div class="selected-display" id="meteoSelected" style="background: #2a3a4b;padding: 8px 12px;border-radius: 10px;margin-top: 8px;min-height: 34px;color: var(--ok);font-size: 13px;font-weight: 700;border: 1px solid var(--border);line-height: 1.2;"></div>
                </div>
                <div class="form-group" data-field="Obstacles">
                    <label>Obstacles (Ctrl pour multiple)</label>
                    <select multiple size="4" id="obstacles">
                        <option>Aucun</option><option>Ligne √©lectrique</option><option>Remont√©es m√©caniques</option>
                        <option>C√¢ble √† bois</option><option>Parapentes</option>
                    </select>
                    <div class="selected-display" id="obstaclesSelected" style="background: #2a3a4b;padding: 8px 12px;border-radius: 10px;margin-top: 8px;min-height: 34px;color: var(--ok);font-size: 13px;font-weight: 700;border: 1px solid var(--border);line-height: 1.2;"></div>
                </div>
            </div>
            <div class="form-group" data-field="Secouristes" style="margin-top: 12px;">
                <label>Secouristes engag√©s</label>
                <div class="secouristes-grid" id="secouristesGrid"></div>
                <div id="secouristesSupp" style="margin-top: 8px;"></div>
                <button type="button" id="btnAddSecouriste" style="background: var(--panel); color: var(--muted); border: 1px dashed var(--border); padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; margin-top: 8px;">+ Ajouter un secouriste ponctuel</button>
            </div>
            <div class="form-group" data-field="Infos moyens" style="margin-top: 12px;">
                <label>Informations compl√©mentaires</label>
                <textarea id="infosMoyens" placeholder="Autres informations..."></textarea>
            </div>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="infosMoyensImportant" style="margin-right:8px;"> IMPORTANT
                </label>
            </div>
        </section>

        <div class="actions">
            <button type="button" class="btn" style="background: #6c757d; color: #fff;" id="btnCancel">Annuler</button>
            <button type="button" class="btn" style="background: #e74c3c; color: #fff;" id="btnReset">üîÑ R√©initialiser</button>
            <button type="button" class="btn btn-green" id="btnSave">üöÅ Cr√©er l'intervention</button>
        </div>
    </div>
    
    <div id="copyConfirmation">Donn√©es copi√©es! coller ctrl+v</div>
    <div id="saveConfirmation">Intervention cr√©√©e!</div>

    <script>
// ===================================================
// COMMUNICATION AVEC LE SYST√àME D'ONGLETS (PARENT)
// ===================================================
let currentTabId = null;
let currentTabData = null;
let modeReadOnly = false; // Mode lecture seule

// R√©cup√©rer l'ID de l'onglet depuis l'URL
const urlParams = new URLSearchParams(window.location.search);
currentTabId = urlParams.get('tabId');
modeReadOnly = urlParams.get('readonly') === 'true'; // D√©tecter le mode lecture seule

// √âcouter les messages du parent
window.addEventListener('message', async function(event) {
    if (event.data.type === 'INIT_TAB') {
        currentTabData = event.data.tabData;
        console.log('üì• Donn√©es onglet re√ßues:', currentTabData);
        
        // Si on a un interventionId et qu'on est en mode lecture seule, charger l'intervention
        if (modeReadOnly && currentTabData.interventionId) {
            // Attendre que init soit termin√©
            await new Promise(resolve => setTimeout(resolve, 500));
            console.log('üîÑ Chargement intervention en mode lecture seule:', currentTabData.interventionId);
            chargerInterventionReadOnly(currentTabData.interventionId);
        }
        // Restaurer les donn√©es locales si elles existent
        else if (currentTabData.donneesLocales && Object.keys(currentTabData.donneesLocales).length > 0) {
            restaurerDonnees(currentTabData.donneesLocales);
        }
    }
});

// Fonction pour envoyer un message au parent
function sendToParent(type, data) {
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type, data }, '*');
    }
}

// Fonction pour restaurer les donn√©es du formulaire
function restaurerDonnees(donnees) {
    // Impl√©menter la restauration des donn√©es si besoin
    console.log('Restauration donn√©es:', donnees);
}

// Fonction pour sauvegarder automatiquement les donn√©es localement
function sauvegarderLocal() {
    if (!currentTabId) return;
    
    try {
        const donnees = {
            origine_alerte: document.getElementById('origineAlerte')?.value,
            activite: document.getElementById('activite')?.value,
            commune: document.getElementById('commune')?.value,
            // ... autres champs selon besoin
        };
        
        sendToParent('UPDATE_TAB', {
            tabId: currentTabId,
            updates: {
                donneesLocales: donnees
            }
        });
        
        console.log('‚úÖ Sauvegarde automatique OK');
    } catch (error) {
        console.error('‚ùå Erreur sauvegarde automatique:', error);
    }
}

// D√âSACTIV√â temporairement - peut causer des probl√®mes
// D√©commentez si vous voulez la sauvegarde auto toutes les 30 secondes
// setInterval(sauvegarderLocal, 30000);

console.log('üìù Fiche d\'alerte charg√©e - Sauvegarde auto D√âSACTIV√âE');

    </script>
    <script>
const SUPABASE_URL='https://vnasjoncvlupdswupfzk.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuYXNqb25jdmx1cGRzd3VwZnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NDQ0MDUsImV4cCI6MjA3NjAyMDQwNX0.2j1_qtxv8giF_HfspdY6XxyOLJYoR6xaSnfi_b2BQ3w';
let supabase,isSupabaseConfigured=false,countryCodes=[],phoneCount=1,victimCount=1,communesCache={},phonesContainer;
const ALERT_NUMBER=1;

try{
    const{createClient}=window.supabase;
    supabase=createClient(SUPABASE_URL,SUPABASE_KEY);
    isSupabaseConfigured=true;
    console.log('‚úÖ Supabase connect√©');
    supabase.from('origines_alerte').select('count').limit(1).then(({data,error})=>{
        if(error){console.error('‚ùå Erreur:',error);showStatus('‚ö†Ô∏è Erreur de connexion',true);}
        else{console.log('‚úÖ Test connexion OK');}
    });
}catch(error){
    console.error('‚ùå Erreur init:',error);
    showStatus('‚ö†Ô∏è Erreur initialisation',true);
}

function showStatus(message,isError){
    const banner=document.getElementById('statusBanner');
    banner.textContent=message;
    banner.className='status-banner'+(isError?' error':'');
    banner.style.display='block';
    setTimeout(()=>{banner.style.display='none';},5000);
}

async function loadCallingCodes(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('calling_codes').select('code, country_name, flag_emoji, phone_format').order('country_name');
        if(error)throw error;
        countryCodes=data.map(item=>({code:item.code,name:`${item.flag_emoji||''} ${item.country_name}`.trim(),placeholder:item.phone_format||'XX XXX XXXX'}));
        const franceIndex=countryCodes.findIndex(c=>c.code==='+33');
        if(franceIndex>-1){const france=countryCodes.splice(franceIndex,1)[0];countryCodes.unshift(france);}
        console.log('‚úÖ Indicatifs:',countryCodes.length);
    }catch(error){
        console.error('Erreur indicatifs:',error);
        countryCodes=[{code:'+33',name:'üá´üá∑ France',placeholder:'06 12 34 56 78'},{code:'+41',name:'üá®üá≠ Suisse',placeholder:'XX XXX XX XX'}];
    }
}

async function loadOriginesAlerte(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('origines_alerte').select('nom').order('ordre');
        if(error)throw error;
        const select=document.getElementById('origineAlerte');
        data.forEach(item=>{const option=document.createElement('option');option.value=item.nom;option.textContent=item.nom;select.appendChild(option);});
        console.log('‚úÖ Origines:',data.length);
    }catch(error){console.error('Erreur origines:',error);}
}

async function loadActivites(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('activites').select('nom').order('nom');
        if(error)throw error;
        const select=document.getElementById('activite');
        data.forEach(item=>{const option=document.createElement('option');option.value=item.nom;option.textContent=item.nom;select.appendChild(option);});
        console.log('‚úÖ Activit√©s:',data.length);
    }catch(error){console.error('Erreur activit√©s:',error);}
}

async function loadCirconstances(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('circonstances').select('nom').order('nom');
        if(error)throw error;
        document.querySelectorAll('.select-circonstances').forEach(select=>{
            select.innerHTML='<option value="">S√©lectionner...</option>';
            data.forEach(item=>{const option=document.createElement('option');option.value=item.nom;option.textContent=item.nom;select.appendChild(option);});
        });
        console.log('‚úÖ Circonstances:',data.length);
    }catch(error){console.error('Erreur circonstances:',error);}
}

async function loadBlessures(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('blessures').select('nom').order('nom');
        if(error)throw error;
        document.querySelectorAll('.select-blessures').forEach(select=>{
            select.innerHTML='';
            data.forEach(item=>{const option=document.createElement('option');option.value=item.nom;option.textContent=item.nom;select.appendChild(option);});
            const victimCard = select.closest('.victim-card');
            if(victimCard){
                const victimId = victimCard.id.split('-')[1];
                const selectedDiv = document.getElementById('blessuresSelected' + victimId);
                if(selectedDiv){
                    setupBlessuresSelect(select, selectedDiv);
                }
            }
        });
        console.log('‚úÖ Blessures:',data.length);
    }catch(error){console.error('Erreur blessures:',error);}
}

async function loadSecouristes(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('secouristes').select('nom').eq('actif',true).order('nom');
        if(error)throw error;
        const grid=document.getElementById('secouristesGrid');
        grid.innerHTML='';
        data.forEach(item=>{const label=document.createElement('label');label.className='checkbox-label';label.innerHTML=`<input type="checkbox" value="${item.nom}"> ${item.nom}`;grid.appendChild(label);});
        console.log('‚úÖ Secouristes:',data.length);
    }catch(error){console.error('Erreur secouristes:',error);}
}

// Fonction pour charger une intervention en mode lecture seule
async function chargerInterventionReadOnly(interventionId) {
    try {
        console.log('üìñ Chargement intervention:', interventionId);
        
        // Charger l'intervention
        const { data: intervention, error: intError } = await supabase
            .from('interventions')
            .select('*')
            .eq('id', interventionId)
            .single();
        
        if (intError) throw intError;
        if (!intervention) {
            alert('‚ùå Intervention introuvable');
            return;
        }
        
        console.log('‚úÖ Intervention charg√©e:', intervention);
        
        // Remplir les champs
        if (intervention.origine_alerte) document.getElementById('origineAlerte').value = intervention.origine_alerte;
        if (intervention.activite) document.getElementById('activite').value = intervention.activite;
        if (intervention.departement) document.getElementById('departement').value = intervention.departement;
        if (intervention.commune) document.getElementById('commune').value = intervention.commune;
        if (intervention.altitude) document.getElementById('altitude').value = intervention.altitude;
        if (intervention.lieu_exact) document.getElementById('lieuExact').value = intervention.lieu_exact;
        if (intervention.infos_requerant) document.getElementById('infosRequerant').value = intervention.infos_requerant;
        
        // T√©l√©phones
        if (intervention.telephones) {
            const phones = JSON.parse(intervention.telephones);
            const phonesContainer = document.getElementById('phonesContainer');
            phonesContainer.innerHTML = '';
            
            phones.forEach((phone, index) => {
                const div = document.createElement('div');
                div.className = 'phone-group';
                div.style.marginTop = index > 0 ? '8px' : '0';
                
                const selectHTML = '<select class="country-code-select" disabled></select>';
                const inputHTML = `<input type="tel" class="phone-input" value="${phone.numero || ''}" readonly>`;
                const nameHTML = `<input type="text" class="phone-name-input" value="${phone.nom || ''}" readonly>`;
                
                div.innerHTML = selectHTML + inputHTML + nameHTML;
                phonesContainer.appendChild(div);
                setupPhoneGroup(div);
                div.querySelector('.country-code-select').value = phone.indicatif;
            });
        }
        
        // Charger les victimes
        const { data: victimes, error: vicError } = await supabase
            .from('victimes')
            .select('*')
            .eq('intervention_id', interventionId)
            .order('numero_victime');
        
        if (!vicError && victimes && victimes.length > 0) {
            const victimesContainer = document.getElementById('victimesContainer');
            victimesContainer.innerHTML = '';
            
            victimes.forEach((victime, index) => {
                const card = createVictimCard(index + 1);
                victimesContainer.appendChild(card);
                
                // Remplir et d√©sactiver
                card.querySelector('.select-sexe').value = victime.sexe || 'Homme';
                card.querySelector('.select-sexe').disabled = true;
                
                if (victime.age) {
                    card.querySelector('.input-age').value = victime.age;
                    card.querySelector('.input-age').readOnly = true;
                }
                
                if (victime.circonstances) {
                    card.querySelector('.select-circonstances').value = victime.circonstances;
                    card.querySelector('.select-circonstances').disabled = true;
                }
                
                if (victime.infos_complementaires) {
                    card.querySelector('.victim-infos-comp').value = victime.infos_complementaires;
                    card.querySelector('.victim-infos-comp').readOnly = true;
                }
                
                if (victime.autre_blessure) {
                    card.querySelector('.blessure-autre-input').value = victime.autre_blessure;
                    card.querySelector('.blessure-autre-input').readOnly = true;
                }
                
                // D√©sactiver le bouton supprimer
                const btnRemove = card.querySelector('.btn-remove-victim');
                if (btnRemove) btnRemove.style.display = 'none';
            });
        }
        
        // D√©sactiver TOUS les champs
        document.querySelectorAll('input, select, textarea, button').forEach(el => {
            if (el.type !== 'button' || el.classList.contains('btn-remove-victim')) {
                el.disabled = true;
            }
        });
        
        // Masquer tous les boutons sauf ceux qu'on va ajouter
        document.querySelectorAll('.btn-green, .btn-copy, .btn-add-phone').forEach(btn => {
            btn.style.display = 'none';
        });
        
        // Ajouter les boutons Imprimer et Fermer en haut
        const header = document.querySelector('h2');
        if (header) {
            const buttonBar = document.createElement('div');
            buttonBar.style.cssText = 'display: flex; gap: 10px; margin: 20px 0;';
            buttonBar.innerHTML = `
                <button onclick="window.print()" class="btn-green" style="display: inline-flex !important;">
                    üìÑ Imprimer
                </button>
                <button onclick="window.close()" class="btn-red" style="display: inline-flex !important;">
                    ‚úï Fermer
                </button>
            `;
            header.after(buttonBar);
        }
        
        console.log('‚úÖ Formulaire rempli en mode lecture seule');
        
    } catch (error) {
        console.error('‚ùå Erreur chargement:', error);
        alert('‚ùå Erreur lors du chargement: ' + error.message);
    }
}

async function saveIntervention(){
    if(!isSupabaseConfigured){alert('‚ö†Ô∏è Supabase non configur√©');return;}
    
    // Validation des champs obligatoires
    const commune = document.getElementById('commune').value;
    if (!commune) {
        alert('‚ö†Ô∏è Veuillez renseigner la commune');
        document.getElementById('commune').focus();
        return;
    }
    
    try{
        // R√©cup√©rer le prochain num√©ro d'alerte disponible pour l'ann√©e en cours
        const currentYear = new Date().getFullYear();
        const { data: maxData, error: maxError } = await supabase
            .from('interventions')
            .select('numero_alerte')
            .eq('annee', currentYear)
            .order('numero_alerte', { ascending: false })
            .limit(1);
        
        let nextNumero = 1;
        if (!maxError && maxData && maxData.length > 0) {
            nextNumero = maxData[0].numero_alerte + 1;
        }
        
        console.log(`üìù Cr√©ation intervention ${nextNumero}/${currentYear}`);
        
        const interventionData={
            date_alerte:new Date().toISOString(),
            numero_alerte:nextNumero,
            annee:currentYear,
            origine_alerte:document.getElementById('origineAlerte').value,
            telephones:Array.from(document.querySelectorAll('#phonesContainer .phone-group')).map(group=>{
                const code=group.querySelector('.country-code-select').value;
                const num=group.querySelector('.phone-input').value.trim();
                const nom=group.querySelector('.phone-name-input').value.trim();
                return num?`${code} ${num}${nom?' ('+nom+')':''}`:'';
            }).filter(v=>v).join(' / '),
            infos_requerant:document.getElementById('infosRequerant').value,
            type_intervention:(document.querySelector('input[name=\"typeIntervention\"]:checked')?.value || null),
            activite:document.getElementById('activite').value,
            departement:document.getElementById('departement').value,
            commune:document.getElementById('commune').value,
            altitude:document.getElementById('altitude').value?parseInt(document.getElementById('altitude').value):null,
            lieu_exact:document.getElementById('lieuExact').value,
            geolocalisation:(() => {
                const exacte = document.getElementById('geolocExacte')?.checked;
                const estimee = document.getElementById('geolocEstimee')?.checked;
                if(exacte && estimee) return 'G√©oloc exacte + Localisation estim√©e';
                if(exacte) return 'G√©oloc exacte';
                if(estimee) return 'Localisation estim√©e';
                return null;
            })(),
            choucas_05:document.getElementById('choucas05').checked,
            equipe_terrestre:document.getElementById('equipeTerrestre').checked,
            secours_medicalise:document.getElementById('secoursMed').checked,
            meteo:Array.from(document.getElementById('meteo').selectedOptions).map(opt=>opt.text).join(', '),
            obstacles:Array.from(document.getElementById('obstacles').selectedOptions).map(opt=>opt.text).join(', '),
            secouristes:Array.from(document.querySelectorAll('#secouristesGrid input[type="checkbox"]:checked')).map(cb=>cb.value).join(', '),
            infos_moyens:(() => {
                let infos = document.getElementById('infosMoyens').value;
                const inf = document.getElementById('secoursInf')?.checked;
                const autreSection = Array.from(document.getElementById('autreSection').selectedOptions).map(opt=>opt.text).join(', ');
                if(inf) infos = (infos ? infos + ' | ' : '') + 'Infirmier';
                if(autreSection) infos = (infos ? infos + ' | ' : '') + 'Autre section: ' + autreSection;
                return infos;
            })(),
            // Nouveaux champs pour le syst√®me multi-onglets
            statut:'intervention_en_cours',
            utilisateur:localStorage.getItem('nom_utilisateur') || 'Utilisateur',
            titre_onglet:commune + ' - ' + new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
            onglet_couleur:'green'
        };
        
        const{data:intervention,error:interventionError}=await supabase.from('interventions').insert([interventionData]).select().single();
        if(interventionError)throw interventionError;
        
        const victimes=[];
        document.querySelectorAll('#victimesContainer .victim-card').forEach((card,index)=>{
            const selectedBlessures=Array.from(card.querySelector('.select-blessures').selectedOptions).map(opt=>opt.text).join(', ');
            const autreBlessure=card.querySelector('.blessure-autre-input').value.trim();
            victimes.push({
                intervention_id:intervention.id,
                numero_victime:index+1,
                sexe:card.querySelector('.select-sexe').value,
                age:card.querySelector('.input-age').value?parseInt(card.querySelector('.input-age').value):null,
                circonstances:card.querySelector('.select-circonstances')?.value || '',
                blessures:selectedBlessures,
                autre_blessure:autreBlessure,
                infos_complementaires:card.querySelector('.victim-infos-comp').value
            });
        });
        
        if(victimes.length>0){
            const{error:victimesError}=await supabase.from('victimes').insert(victimes);
            if(victimesError)throw victimesError;
        }
        
        showSaveConfirmation();
        console.log('‚úÖ Intervention cr√©√©e:',intervention.id);
        
        // Collecter TOUTES les donn√©es pour g√©n√©rer le message complet
        const messageData = {
            'Requ√©rant': collectSectionData('sectionRequerant'),
            'Localisation': collectSectionData('sectionLocalisation'),
            'Victime': collectSectionData('sectionVictimes'),
            'Moyens engag√©s': collectSectionData('sectionMoyens')
        };
        
        // G√©n√©rer le message format√©
        const messageFormate = formatMessage(messageData);
        
        // Copier automatiquement dans le presse-papier
        try {
            await navigator.clipboard.writeText(messageFormate);
            console.log('‚úÖ Message copi√© dans le presse-papier');
        } catch (err) {
            console.error('‚ùå Erreur copie presse-papier:', err);
        }
        
        // Afficher le message de confirmation sp√©cial
        alert('‚úÖ Intervention cr√©√©e !\n\nVous pouvez maintenant coller la fiche dans le fil TCHAP Secours (Ctrl+V)');
        
        // Notifier le parent pour basculer vers le formulaire terrain
        sendToParent('UPDATE_TAB', {
            tabId: currentTabId,
            updates: {
                interventionId: intervention.id,
                titre: intervention.titre_onglet,
                statut: 'intervention_en_cours',
                couleur: 'green',
                phase: 'terrain'
            }
        });
        
        sendToParent('SHOW_NOTIFICATION', {
            message: '‚úÖ Intervention cr√©√©e - Basculement vers le formulaire terrain',
            level: 'info'
        });
        
        // Attendre 3 secondes avant de basculer pour que l'utilisateur voie le message
        setTimeout(() => {
            sendToParent('SWITCH_PHASE', {
                tabId: currentTabId,
                phase: 'terrain'
            });
        }, 3000);
        
    }catch(error){console.error('Erreur:',error);alert('‚ùå Erreur : '+error.message);}
}

function showSaveConfirmation(){const conf=document.getElementById('saveConfirmation');conf.style.opacity=1;setTimeout(()=>{conf.style.opacity=0;},2000);}

// Fonction pour ajouter un t√©l√©phone
function ajouterTelephone() {
    if(!phonesContainer) {
        console.error('‚ùå phonesContainer introuvable');
        phonesContainer = document.getElementById('phonesContainer');
    }
    
    if(!phonesContainer) {
        console.error('‚ùå Impossible de trouver phonesContainer');
        alert('Erreur: conteneur de t√©l√©phones introuvable');
        return;
    }
    
    if(phoneCount>=3){
        alert('Maximum 3 num√©ros');
        return;
    }
    
    console.log('‚úÖ Ajout nouveau t√©l√©phone, count:', phoneCount);
    phoneCount++;
    
    const div=document.createElement('div');
    div.className='phone-group';
    div.style.marginTop='8px';
    div.innerHTML='<select class="country-code-select"></select><input type="tel" class="phone-input" placeholder="06 12 34 56 78" maxlength="20" inputmode="tel" autocomplete="tel"><input type="text" class="phone-name-input" placeholder="Nom" maxlength="20"><button type="button" class="btn-remove-phone">‚àí</button>';
    phonesContainer.appendChild(div);
    setupPhoneGroup(div);
    div.querySelector('.btn-remove-phone').addEventListener('click',function(){
        div.remove();
        phoneCount--;
        console.log('üóëÔ∏è T√©l√©phone supprim√©, count:', phoneCount);
    });
    
    console.log('‚úÖ Nouveau t√©l√©phone ajout√© avec succ√®s');
}

async function init(){
    console.log('üéØ FONCTION INIT APPEL√âE - D√âBUT');
    const now=new Date();
    console.log('üöÄ D√©marrage...', now);
    
    // Initialiser phonesContainer d√®s le d√©but
    phonesContainer = document.getElementById('phonesContainer');
    
    await Promise.all([loadCallingCodes(),loadOriginesAlerte(),loadActivites(),loadCirconstances(),loadBlessures(),loadSecouristes()]);
    
    const firstPhoneGroup = document.querySelector('#phonesContainer .phone-group');
    if(firstPhoneGroup) {
        setupPhoneGroup(firstPhoneGroup);
    }
    
    const initialDep=document.getElementById('departement').value;
    const communes=await loadCommunes(initialDep);
    updateCommunesList(communes);
    
    // Initialiser m√©t√©o/obstacles
    const meteoEl = document.getElementById('meteo');
    const obstaclesEl = document.getElementById('obstacles');
    if(meteoEl) {
        meteoEl.addEventListener('change', updateMeteoDisplay);
        updateMeteoDisplay();
    }
    if(obstaclesEl) {
        obstaclesEl.addEventListener('change', updateObstaclesDisplay);
        updateObstaclesDisplay();
    }
    
    // Texte "Autre" cliquable pour origine de l'alerte
    const btnAutre = document.getElementById('btnAutreOrigine');
    if(btnAutre) {
        btnAutre.addEventListener('click', function() {
            const autreWrap = document.getElementById('autreOrigineWrap');
            const isVisible = autreWrap.style.display !== 'none';
            
            if (isVisible) {
                autreWrap.style.display = 'none';
                this.textContent = 'Autre';
            } else {
                autreWrap.style.display = 'block';
                this.textContent = 'Masquer';
                document.getElementById('autreOrigineTexte').focus();
            }
        });
    }
    
    // Collapsible pour Infos requ√©rant
    const infosToggle = document.getElementById('infosRequerantToggle');
    if(infosToggle) {
        infosToggle.addEventListener('click', function() {
            const content = document.getElementById('infosRequerantContent');
            const isVisible = content.style.display !== 'none';
            
            if (isVisible) {
                content.style.display = 'none';
                this.classList.remove('active');
            } else {
                content.style.display = 'block';
                this.classList.add('active');
                setTimeout(() => {
                    document.getElementById('infosRequerant').focus();
                }, 100);
            }
        });
    }
    
    // Bouton Coller goutte Gendloc
    const btnGendloc = document.getElementById('btnGendloc');
    if(btnGendloc) {
        btnGendloc.addEventListener('click', async function() {
            try {
                const text = await navigator.clipboard.readText();
                
                if (!text || text.trim() === '') {
                    alert('‚ö†Ô∏è Le presse-papier est vide. Copiez d\'abord la goutte Gendloc.');
                    return;
                }
                
                if (!text.includes('EVENEMENT') && !text.includes('geo:') && !text.includes('LAT')) {
                    const confirmation = confirm('Le contenu copi√© ne ressemble pas √† une goutte Gendloc.\\n\\nVoulez-vous quand m√™me l\'enregistrer ?');
                    if (!confirmation) return;
                }
                
                gendlocData = text;
                
                const status = document.getElementById('gendlocStatus');
                status.style.display = 'inline-flex';
                
                this.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
                this.textContent = '‚úÖ Goutte enregistr√©e';
                
                analyserGendloc(text);
                
                setTimeout(() => {
                    this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    this.textContent = 'üìç Coller goutte Gendloc';
                }, 3000);
                
                console.log('‚úÖ Goutte Gendloc enregistr√©e:', text.substring(0, 100) + '...');
                
            } catch (error) {
                console.error('Erreur lecture presse-papier:', error);
                alert('‚ùå Erreur : Impossible de lire le presse-papier.\\n\\nAssurez-vous d\'avoir copi√© la goutte Gendloc (Ctrl+C).');
            }
        });
    }
    
    // Gestion des secouristes suppl√©mentaires
    const btnAddSecouriste = document.getElementById('btnAddSecouriste');
    if(btnAddSecouriste) {
        let secouristesSuppCount = 0;
        btnAddSecouriste.addEventListener('click', function() {
            if (secouristesSuppCount >= 2) {
                alert('‚ö†Ô∏è Vous pouvez ajouter maximum 2 secouristes suppl√©mentaires');
                return;
            }
            
            secouristesSuppCount++;
            const suppDiv = document.getElementById('secouristesSupp');
            const newSecouriste = document.createElement('div');
            newSecouriste.style.display = 'inline-block';
            newSecouriste.style.marginRight = '8px';
            newSecouriste.style.marginTop = '8px';
            newSecouriste.innerHTML = `
                <input type="text" class="secouriste-supp-input" placeholder="Nom" maxlength="15" style="width: 120px; display: inline-block; padding: 6px 8px; font-size: 12px;">
                <button type="button" class="btn-remove-phone" style="width: 24px; height: 24px; font-size: 14px; padding: 0; display: inline-block; vertical-align: middle; margin-left: 4px;" onclick="this.parentElement.remove();">√ó</button>
            `;
            suppDiv.appendChild(newSecouriste);
        });
    }
    
    // Gestion du bouton R√©initialiser
    const btnReset = document.getElementById('btnReset');
    if(btnReset) {
        btnReset.addEventListener('click', function() {
            if(confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser le formulaire ?\n\nToutes les donn√©es saisies seront perdues.')) {
                // R√©initialiser tous les champs texte et textarea
                document.querySelectorAll('input[type="text"], input[type="tel"], input[type="number"], textarea').forEach(input => {
                    input.value = '';
                });
                
                // R√©initialiser tous les select
                document.querySelectorAll('select').forEach(select => {
                    if(select.multiple) {
                        // Pour les select multiple, d√©selectionner tout
                        Array.from(select.options).forEach(opt => opt.selected = false);
                    } else {
                        select.selectedIndex = 0;
                    }
                });
                
                // R√©initialiser toutes les checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                
                // Supprimer les victimes ajout√©es (garder seulement la premi√®re)
                const victimCards = document.querySelectorAll('#victimesContainer .victim-card');
                victimCards.forEach((card, index) => {
                    if(index > 0) card.remove();
                });
                victimCount = 1;
                
                // Supprimer les t√©l√©phones ajout√©s (garder seulement le premier)
                const phoneGroups = document.querySelectorAll('#phonesContainer .phone-group');
                phoneGroups.forEach((group, index) => {
                    if(index > 0) group.remove();
                });
                phoneCount = 1;
                
                // Supprimer les secouristes suppl√©mentaires
                document.getElementById('secouristesSupp').innerHTML = '';
                
                // R√©initialiser les displays de s√©lection
                document.getElementById('meteoSelected').innerHTML = '';
                document.getElementById('obstaclesSelected').innerHTML = '';
                document.getElementById('autreSectionSelected').innerHTML = '';
                document.querySelectorAll('.blessures-selected').forEach(div => div.innerHTML = '');
                
                // R√©initialiser la goutte Gendloc
                gendlocData = null;
                document.getElementById('gendlocStatus').style.display = 'none';
                
                // Remettre le d√©partement par d√©faut
                document.getElementById('departement').value = '05';
                
                // Message de confirmation
                alert('‚úÖ Formulaire r√©initialis√© !');
                
                // Scroll en haut
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        });
    }
    
    // Collapsible pour Autre section
    const autreSectionToggle = document.getElementById('autreSectionToggle');
    if(autreSectionToggle) {
        autreSectionToggle.addEventListener('click', function() {
            const content = document.getElementById('autreSectionContent');
            const arrow = this.querySelector('.arrow');
            const isVisible = content.style.display !== 'none';
            
            if (isVisible) {
                content.style.display = 'none';
                arrow.textContent = '‚ñº';
                this.classList.remove('active');
            } else {
                content.style.display = 'block';
                arrow.textContent = '‚ñ≤';
                this.classList.add('active');
            }
        });
    }
    
    // Gestion du menu "Autre section"
    const autreSectionEl = document.getElementById('autreSection');
    if(autreSectionEl) {
        autreSectionEl.addEventListener('change', updateAutreSectionDisplay);
        updateAutreSectionDisplay();
    }
    
    // Gestion du bouton + pour ajouter un t√©l√©phone - DOUBLE APPROCHE
    console.log('üîç Initialisation gestionnaire bouton +');
    
    // APPROCHE 1 : Gestionnaire direct sur le bouton
    const btnAddPhone = document.querySelector('.btn-add-phone');
    console.log('üîç Bouton + trouv√©:', !!btnAddPhone);
    
    if (btnAddPhone) {
        // TEST: V√©rifier la position et visibilit√© du bouton
        const rect = btnAddPhone.getBoundingClientRect();
        const computedStyle = window.getComputedStyle(btnAddPhone);
        console.log('üîç Position bouton:', {
            top: rect.top,
            left: rect.left,
            width: rect.width,
            height: rect.height,
            visible: rect.width > 0 && rect.height > 0,
            pointerEvents: computedStyle.pointerEvents,
            zIndex: computedStyle.zIndex,
            display: computedStyle.display
        });
        
        // Forcer le style pour √™tre S√õR qu'il est cliquable
        btnAddPhone.style.pointerEvents = 'auto';
        btnAddPhone.style.position = 'relative';
        btnAddPhone.style.zIndex = '9999';
        btnAddPhone.style.cursor = 'pointer';
        
        // TEST: V√©rifier si les √©v√©nements souris arrivent
        let dernierAjout = 0;
        const DEBOUNCE_DELAY = 1000; // 1 seconde pour √©viter les doubles clics
        
        function ajouterAvecDebounce() {
            const maintenant = Date.now();
            const delai = maintenant - dernierAjout;
            console.log(`‚è±Ô∏è D√©lai depuis dernier ajout: ${delai}ms`);
            
            if (maintenant - dernierAjout < DEBOUNCE_DELAY) {
                console.log('‚è∏Ô∏è Ajout ignor√© (debounce)');
                return;
            }
            dernierAjout = maintenant;
            console.log('‚úÖ Ajout d√©clench√©');
            ajouterTelephone();
        }
        
        btnAddPhone.addEventListener('mouseenter', function() {
            console.log('üñ±Ô∏è SOURIS ENTRE dans le bouton +');
            btnAddPhone.style.transform = 'scale(1.1)';
        });
        
        btnAddPhone.addEventListener('mouseleave', function() {
            console.log('üñ±Ô∏è SOURIS SORT du bouton +');
            btnAddPhone.style.transform = 'scale(1)';
        });
        
        // SOLUTION: Utiliser mousedown qui fonctionne mieux que click dans les iframes
        btnAddPhone.addEventListener('mousedown', function(e) {
            console.log('üñ±Ô∏è MOUSEDOWN d√©tect√© - AJOUT');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation(); // Emp√™che les autres listeners
            ajouterAvecDebounce();
            return false;
        }, { once: false, capture: true }); // capture = true pour √™tre le premier
        
        console.log('‚úÖ Gestionnaire mousedown install√© avec debounce de', DEBOUNCE_DELAY, 'ms');
    }
    
    console.log('‚úÖ App OK');
}

// Attendre que le DOM soit compl√®tement charg√©
console.log('üîß Script charg√©, readyState:', document.readyState);

if (document.readyState === 'loading') {
    console.log('‚è≥ DOM en cours de chargement, attente DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOMContentLoaded d√©clench√©');
        init();
    });
} else {
    // Le DOM est d√©j√† charg√©
    console.log('‚úÖ DOM d√©j√† charg√©, lancement imm√©diat de init()');
    init();
}

function populateCountryCodes(selectElement){
    selectElement.innerHTML='';
    if(countryCodes.length===0){const option=document.createElement('option');option.value='+33';option.textContent='üá´üá∑ France (+33)';selectElement.appendChild(option);}
    else{countryCodes.forEach(country=>{const option=document.createElement('option');option.value=country.code;option.textContent=`${country.name} (${country.code})`;selectElement.appendChild(option);});}
    selectElement.value='+33';
}

function updatePlaceholder(selectElement){
    const group = selectElement ? selectElement.closest('.phone-group-inner') : null;
    const inputElement = group ? group.querySelector('.phone-input') : null;
    if(!inputElement || !selectElement){ return; }
    const code=selectElement.value;
    const country=countryCodes.find(c=>c.code===code);
    inputElement.placeholder=country?country.placeholder:'Num√©ro';
    if(code === '+33'){
        inputElement.value = formatFrenchMobile(inputElement.value);
        inputElement.maxLength = 14;
    } else {
        inputElement.value = digitsOnly(inputElement.value).slice(0,20);
        inputElement.maxLength = 23;
    }
}

function setupPhoneGroup(group){
    if(!group) return;
    const select=group.querySelector('.country-code-select');
    const input=group.querySelector('.phone-input');
    if(!select || !input) return;
    populateCountryCodes(select);
    updatePlaceholder(select);
    select.addEventListener('change',()=>updatePlaceholder(select));
    input.addEventListener('input',formatPhone);
    input.addEventListener('paste',handlePhonePaste);
    input.addEventListener('blur',()=>{
        const code = select.value;
        if(code === '+33' && input.value.trim()!==''){
            if(!isValidFrenchMobile(input.value)){
                input.setCustomValidity('Num√©ro fran√ßais invalide (ex: 06 12 34 56 78)');
            } else {
                input.setCustomValidity('');
            }
        } else {
            input.setCustomValidity('');
        }
    });
}

function digitsOnly(s){ return (s||'').replace(/[\u00A0\s\-.]/g,'').replace(/\D/g,''); }

function formatFrenchMobile(val){
    let d = digitsOnly(val).slice(0,10);
    let out = '';
    for(let i=0;i<d.length;i++){
        if(i>0 && i%2===0) out+=' ';
        out += d[i];
    }
    return out;
}

function formatPhone(e){
    const phoneGroup = e.target.closest('.phone-group');
    if (!phoneGroup) return;
    const code = phoneGroup.querySelector('.country-code-select')?.value || '+33';
    if(code==='+33'){
        let val=e.target.value.replace(/\D/g,'');
        if(val.length>10)val=val.substring(0,10);
        let formatted='';
        for(let i=0;i<val.length;i++){if(i>0&&i%2===0)formatted+=' ';formatted+=val[i];}
        e.target.value=formatted;
        e.target.maxLength=14;
    }else{
        let val=e.target.value.replace(/[^\d\s]/g,'');
        if(val.length>20)val=val.substring(0,20);
        e.target.value=val;
        e.target.maxLength=20;
    }
}

function handlePhonePaste(e){
    const input = e.target;
    const group = input.closest('.phone-group');
    if(!group) return;
    const code = group.querySelector('.country-code-select')?.value || '+33';
    let text = (e.clipboardData || window.clipboardData).getData('text');
    if(!text) return;
    e.preventDefault();
    if(code === '+33'){
        input.value = formatFrenchMobile(text);
        input.maxLength = 14;
    }else{
        let clean = digitsOnly(text).slice(0,20);
        let chunks = [];
        while(clean.length){
            if(clean.length > 4) { chunks.push(clean.slice(0,3)); clean = clean.slice(3); }
            else { chunks.push(clean); clean=''; }
        }
        input.value = chunks.join(' ');
        input.maxLength = 23;
    }
}

function isValidFrenchMobile(val){
    const d = digitsOnly(val);
    return /^0\d{9}$/.test(d);
}

document.querySelectorAll('.btn-arrow').forEach(btn=>{btn.addEventListener('click',function(){const target=this.getAttribute('data-target');if(target){document.getElementById(target).scrollIntoView({behavior:'smooth',block:'start'});}});});

async function loadCommunes(dep){
    if(communesCache[dep])return communesCache[dep];
    try{
        const res=await fetch(`https://geo.api.gouv.fr/departements/${dep}/communes?fields=nom`);
        const data=await res.json();
        data.sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'}));
        communesCache[dep]=data;
        return data;
    }catch(err){console.error('Erreur communes:',err);return[];}
}

function normalizeText(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

function updateCommunesList(communes,filterTerm=''){
    const dl=document.getElementById('communesList');
    dl.innerHTML='';
    const normTerm = normalizeText(filterTerm);
    const communesToDisplay = normTerm
        ? communes.filter(c => normalizeText(c.nom).startsWith(normTerm))
        : communes;
    communesToDisplay.forEach(c=>{const opt=document.createElement('option');opt.value=c.nom;dl.appendChild(opt);});
}

const departementSelect=document.getElementById('departement');
const communeInput=document.getElementById('commune');
departementSelect.addEventListener('change',async function(){const dep=this.value;const communes=await loadCommunes(dep);updateCommunesList(communes);communeInput.value='';});
communeInput.addEventListener('input',async function(){const term=this.value;const dep=departementSelect.value;const communes=await loadCommunes(dep);updateCommunesList(communes,term);});

function parseAndFillGPS(pasteValue,prefix){
    const regex=/(\d+)\s*[¬∞¬∫]\s*(\d+)'\s*([\d\.]*)"?\s*.*?(\d+)\s*[¬∞¬∫]\s*(\d+)'\s*([\d\.]*)"?/i;
    const match=pasteValue.match(regex);
    if(match){
        const[,latD,latM,latS,lngD,lngM,lngS]=match;
        document.getElementById(prefix+'LatD').value=latD.trim();
        document.getElementById(prefix+'LatM').value=latM.trim();
        document.getElementById(prefix+'LatS').value=parseFloat(latS).toFixed(2).replace(/\.00$/,'').replace(/^0\./,'.')||'0';
        document.getElementById(prefix+'LngD').value=lngD.trim();
        document.getElementById(prefix+'LngM').value=lngM.trim();
        document.getElementById(prefix+'LngS').value=parseFloat(lngS).toFixed(2).replace(/\.00$/,'').replace(/^0\./,'.')||'0';
    }else{alert("Format non reconnu");}
}

// gpsPaste supprim√© - utiliser les 3 formats de coordonn√©es
// amlPaste supprim√© - utiliser les 3 formats de coordonn√©es

function setupBlessuresSelect(selectElement,selectedDivElement){
    if(!(selectElement&&selectedDivElement)) return;
    const otherInput = selectElement.closest('.blessures-row')?.querySelector('.blessure-autre-input');

    function render(){
        const labels = Array.from(selectElement.selectedOptions).map(o=>o.text.trim()).filter(Boolean);
        const other = (otherInput && otherInput.value.trim()) ? otherInput.value.trim() : null;
        const items = other ? [...labels, other] : labels;
        selectedDivElement.innerHTML = items.length
            ? items.map(txt=>`<span class="blessure-badge">${txt}</span>`).join(' ')
            : '';
    }

    selectElement.addEventListener('change', render);
    if(otherInput){
        otherInput.addEventListener('input', render);
    }
    render();
}

const victimesContainer=document.getElementById('victimesContainer');
const btnAddVictim=document.getElementById('btnAddVictim');

function createVictimCard(index){
    const card=document.createElement('div');
    card.className='victim-card';
    card.id=`victim-${index}`;
    card.innerHTML=`<div class="victim-header"><h4>Victime ${index}</h4><button type="button" class="btn-red btn-remove-victim">Supprimer</button></div><div class="form-row-custom" style="grid-template-columns: 140px 110px 1fr; gap: 14px; margin-bottom: 14px;"><div class="form-group" data-field="Sexe"><label>Sexe</label><select class="select-sexe"><option value="Homme">Homme</option><option value="Femme">Femme</option></select></div><div class="form-group" data-field="√Çge"><label>√Çge</label><input type="number" class="input-age" placeholder="25"></div><div class="form-group" data-field="Circonstances"><label>Circonstances</label><select class="select-circonstances"><option value="">S√©lectionner...</option></select></div></div><div class="form-group victim-blessures-group"><label>Blessures (Ctrl pour s√©lection multiple)</label><div class="blessures-row"><select multiple size="5" id="blessures${index}" class="select-blessures"></select><div class="form-group" data-field="Autre blessure" style="flex-grow: 1;"><label style="margin-top: 0;">Autre blessure</label><input type="text" placeholder="Description libre..." class="blessure-autre-input"></div></div><div class="blessures-selected" id="blessuresSelected${index}" style="margin-top: 8px;"></div></div><div class="form-group" data-field="Infos compl√©mentaires" style="margin-top: 15px;"><label>Informations compl√©mentaires</label><textarea placeholder="Infos suppl√©mentaires..." rows="2" class="victim-infos-comp"></textarea></div>`;
    card.querySelector('.btn-remove-victim').addEventListener('click',function(){card.remove();});
    
    // Charger les circonstances pour ce nouveau select
    loadCirconstances();
    
    // Charger les blessures
    loadBlessures();
    
    const selectElement=card.querySelector(`#blessures${index}`);
    const selectedDivElement=card.querySelector(`#blessuresSelected${index}`);
    setupBlessuresSelect(selectElement,selectedDivElement);
    return card;
}

btnAddVictim.addEventListener('click',function(){victimCount++;const newCard=createVictimCard(victimCount);victimesContainer.appendChild(newCard);newCard.scrollIntoView({behavior:'smooth',block:'start'});});

function collectSectionData(sectionId){
    const section=document.getElementById(sectionId);
    const data={};
    if(!section)return data;
    
    if(sectionId==='sectionVictimes'){
        const victimsData=[];
        document.querySelectorAll('#victimesContainer .victim-card').forEach((card,index)=>{
            const vData={};
            const sexeVal = card.querySelector('.select-sexe')?.value;
            const ageVal = card.querySelector('.input-age')?.value;
            const circVal = card.querySelector('.select-circonstances')?.value;
            
            vData['Sexe']=sexeVal || 'NC';
            vData['√Çge']=ageVal || 'NC';
            vData['Circonstances']=circVal || 'NC';
            
            const blessuresSelect = card.querySelector('.select-blessures');
            const selectedBlessures = blessuresSelect ? Array.from(blessuresSelect.selectedOptions).map(opt=>opt.text).join(', ') : '';
            const autreBlessure=card.querySelector('.blessure-autre-input')?.value.trim() || '';
            
            let blessures=selectedBlessures;
            if(autreBlessure){
                if(blessures) {
                    blessures += ' (Autre: ' + autreBlessure + ')';
                } else {
                    blessures = autreBlessure;
                }
            }
            vData['Blessures']=blessures||'Inconnues';
            vData['Infos compl√©mentaires']=card.querySelector('.victim-infos-comp')?.value.trim()||'RAS';
            victimsData.push(vData);
        });
        data['Victimes']=victimsData;
        return data;
    }
    
    if(sectionId==='sectionMoyens'){
        const moyensEngages = [];
        if(document.getElementById('choucas05')?.checked) moyensEngages.push('CHOUCAS 05');
        if(document.getElementById('secoursMed')?.checked) moyensEngages.push('Secours m√©dicalis√©');
        if(document.getElementById('secoursInf')?.checked) moyensEngages.push('Infirmier');
        if(document.getElementById('equipeTerrestre')?.checked) moyensEngages.push('√âquipe terrestre');
        
        // Ajouter les autres sections s√©lectionn√©es
        const autreSectionSelect = document.getElementById('autreSection');
        if(autreSectionSelect) {
            const autreSectionValue = Array.from(autreSectionSelect.selectedOptions).map(opt=>opt.text);
            if(autreSectionValue.length > 0) {
                moyensEngages.push(...autreSectionValue);
            }
        }
        
        if(moyensEngages.length > 0) data['Moyens'] = moyensEngages.join(', ');
        
        const meteoSelect = document.getElementById('meteo');
        if(meteoSelect) {
            const meteoValue = Array.from(meteoSelect.selectedOptions).map(opt=>opt.text).join(', ');
            if(meteoValue) data['M√©t√©o'] = meteoValue;
        }
        
        const obstaclesSelect = document.getElementById('obstacles');
        if(obstaclesSelect) {
            const obstaclesValue = Array.from(obstaclesSelect.selectedOptions).map(opt=>opt.text).join(', ');
            if(obstaclesValue) data['Obstacles'] = obstaclesValue;
        }
        
        // Collecter les secouristes standards + suppl√©mentaires
        const secouristesChecked = Array.from(document.querySelectorAll('#secouristesGrid input[type="checkbox"]:checked')).map(cb=>cb.value);
        const secouristesSupp = Array.from(document.querySelectorAll('.secouriste-supp-input')).map(input=>input.value.trim()).filter(v=>v);
        const tousSecouristes = [...secouristesChecked, ...secouristesSupp];
        if(tousSecouristes.length > 0) data['Secouristes'] = tousSecouristes.join(', ');
        
        const infosMoyens = document.getElementById('infosMoyens')?.value.trim();
        if(infosMoyens) data['Infos moyens'] = infosMoyens;
        
        const infosMoyensImportant = document.getElementById('infosMoyensImportant')?.checked || false;
        if(infosMoyensImportant){ data['Infos moyens important'] = true; }
    return data;
    }
    
    section.querySelectorAll('.form-group').forEach(group=>{
        const fieldName=group.getAttribute('data-field');
        if(!fieldName)return;
        let value='';
        const input=group.querySelector('input:not([type="radio"]):not([type="checkbox"]), select:not([multiple]):not(.country-code-select), textarea');
        if(input)value=input.value.trim();
        const radio=group.querySelector('input[type="radio"]:checked');
        if(radio)value=radio.value;
        const multipleSelect=group.querySelector('select[multiple]');
        if(multipleSelect)value=Array.from(multipleSelect.selectedOptions).map(opt=>opt.text).join(', ');
        const checkboxes=group.querySelectorAll('input[type="checkbox"]:checked');
        if(checkboxes.length>0&&!input&&!radio&&!multipleSelect){value=Array.from(checkboxes).map(cb=>cb.value).join(', ');}
        if(fieldName==="T√©l√©phones"){value=Array.from(document.querySelectorAll('#phonesContainer .phone-group')).map(group=>{const code=group.querySelector('.country-code-select').value;const num=group.querySelector('.phone-input').value.trim();const nom=group.querySelector('.phone-name-input').value.trim();return num?`${code} ${num}${nom?' ('+nom+')':''}`:'';}).filter(v=>v).join(' / ');}
        if(value)data[fieldName]=value;
    });
    
    if(sectionId==='sectionLocalisation'){
        // Ajouter les cases √† cocher de pr√©cision
        const geolocExacte = document.getElementById('geolocExacte')?.checked;
        const geolocEstimee = document.getElementById('geolocEstimee')?.checked;
        
        let precision = '';
        if(geolocExacte && geolocEstimee) {
            precision = 'G√©oloc exacte, Localisation estim√©e';
        } else if(geolocExacte) {
            precision = 'G√©oloc exacte';
        } else if(geolocEstimee) {
            precision = 'Localisation estim√©e';
        }
        
        if(precision) data['Pr√©cision localisation'] = precision;
    }
    
    return data;
}

function formatMessage(data){
    const now = new Date();
    const timeStr = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    let message=`üö® ALERTE N¬∞${ALERT_NUMBER} - ${timeStr}\n`;
    
    // D√©terminer l'intervenant pour le titre
    let intervenant = '';
    if(data['Moyens engag√©s']?.Moyens) {
        if(data['Moyens engag√©s'].Moyens.includes('CHOUCAS 05')) intervenant = 'CRS Brian√ßon';
        else if(data['Moyens engag√©s'].Moyens.includes('CRS Grenoble')) intervenant = 'CRS Grenoble';
        else if(data['Moyens engag√©s'].Moyens.includes('CRS Albertville')) intervenant = 'CRS Albertville';
        else if(data['Moyens engag√©s'].Moyens.includes('PGHM04')) intervenant = 'PGHM04';
    }
    
    if(intervenant) {
        message += `\n${'‚îÄ'.repeat(10)} ${intervenant} ${'‚îÄ'.repeat(10)}\n`;
    }
    
    // --- REQU√âRANT ---
    if(data.Requ√©rant){
        message+=`\nüë§ REQU√âRANT\n`;
        message+=`   Origine: ${data.Requ√©rant["Origine de l'alerte"]||'NC'}\n`;
        message+=`   Activit√©: ${data.Requ√©rant['Activit√©']||'NC'}\n`;
        message+=`   Tel: ${data.Requ√©rant['T√©l√©phones']||'NC'}\n`;
        if(data.Requ√©rant['Infos requ√©rant']){
            message+=`   ‚ÑπÔ∏è ${data.Requ√©rant['Infos requ√©rant']}\n`;
        }
    }
    
    // --- LOCALISATION ---
    if(data.Localisation){
        message+=`\nüìç LOCALISATION\n`;
        message+=`   ${data.Localisation['Commune']||'NC'} (${data.Localisation['D√©partement']||'05'})`;
        if(data.Localisation['Altitude']) message+=` - ${data.Localisation['Altitude']}m`;
        message+=`\n`;
        message+=`   Lieu: ${data.Localisation['Lieu exact']||'NC'}`;
        if(data.Localisation['Pr√©cision localisation']){
            message+=` [${data.Localisation['Pr√©cision localisation']}]`;
        }
        message+=`\n`;
        
        // Gendloc
        if (gendlocData) {
            message+=`   üìç GENDLOC: ${gendlocData.replace(/\n/g, ' ')}\n`;
        }
    }
    
    // --- VICTIMES ---
    if(data.Victime && data.Victime.Victimes && data.Victime.Victimes.length>0){
        message+=`\nüöë VICTIME${data.Victime.Victimes.length > 1 ? 'S' : ''} (${data.Victime.Victimes.length})\n`;
        data.Victime.Victimes.forEach((v,i)=>{
            message+=`   ${i+1}. ${v.Sexe}, ${v.√Çge} ans - ${v.Circonstances}\n`;
            message+=`      Blessures: ${v.Blessures}\n`;
            if(v['Infos compl√©mentaires']!=='RAS'){
                message+=`      ‚ÑπÔ∏è ${v['Infos compl√©mentaires']}\n`;
            }
        });
    }
    
    // --- MOYENS ENGAG√âS ---
    if(data['Moyens engag√©s']){
        const moyensData = data['Moyens engag√©s']; 
        message+=`\nüöÅ MOYENS ENGAG√âS\n`;
        
        const moyens = [];
        if(moyensData.Moyens?.includes('CHOUCAS 05')) moyens.push('CHOUCAS 05');
        if(moyensData.Moyens?.includes('√âquipe terrestre')) moyens.push('√âquipe terrestre');
        if(moyensData.Moyens?.includes('Secours m√©dicalis√©')) moyens.push('Secours m√©dicalis√©');
        if(moyensData.Moyens?.includes('Infirmier')) moyens.push('Infirmier');
        if(moyensData.Moyens?.includes('CRS Grenoble')) moyens.push('CRS Grenoble');
        if(moyensData.Moyens?.includes('CRS Albertville')) moyens.push('CRS Albertville');
        if(moyensData.Moyens?.includes('PGHM04')) moyens.push('PGHM04');
        
        if(moyens.length > 0) message+=`   ${moyens.join(', ')}\n`;
        
        // M√©t√©o et obstacles
        if(moyensData['M√©t√©o'] && moyensData['M√©t√©o'] !== 'NC') {
            message+=`   M√©t√©o: ${moyensData['M√©t√©o']}\n`;
        }
        if(moyensData['Obstacles'] && moyensData['Obstacles'] !== 'Aucun') {
            message+=`   Obstacles: ${moyensData['Obstacles']}\n`;
        }
        
        if(moyensData['Secouristes']){
            message+=`   Secouristes: ${moyensData['Secouristes']}\n`;
        }
        
        if(moyensData['Infos moyens']){
            message+=`   ${moyensData['Infos moyens important']?'‚ö†Ô∏è':'‚ÑπÔ∏è'} ${moyensData['Infos moyens']}\n`;
        }
    }
    
    return message.trim();
}

function showCopyConfirmation(){const conf=document.getElementById('copyConfirmation');conf.style.opacity=1;setTimeout(()=>{conf.style.opacity=0;},2000);}

document.querySelectorAll('.btn-copy').forEach(btn=>{
    btn.addEventListener('click',async function(){
        const sectionId=this.getAttribute('data-section');
        const data={};
        const sections=['sectionRequerant','sectionLocalisation','sectionVictimes','sectionMoyens'];
        
        for(let i=0;i<sections.length;i++){
            const sId=sections[i];
            // Utilise l'attribut data-section-name de la balise section
            const sectionName=document.getElementById(sId).getAttribute('data-section-name');
            
            // 1. Collecter les donn√©es de la section
            // 'Victime(s)' est le seul nom de section qui est trait√© diff√©remment (data.Victime)
            if(sId==='sectionVictimes'){
                data.Victime=collectSectionData(sId);
            } else {
                // Pour toutes les autres, utilise le sectionName comme cl√© (ex: data['Moyens engag√©s'])
                data[sectionName]=collectSectionData(sId);
            }

            // 2. Si c'est le bouton de cette section, on s'arr√™te APR√àS avoir collect√© ses donn√©es
            if(sId===sectionId)break; 
        }
        
        const message=formatMessage(data);
        try{await navigator.clipboard.writeText(message);showCopyConfirmation();}catch(err){console.error('Erreur:',err);prompt(`‚ö†Ô∏è Copier manuellement :`,message);}
    });
});

document.getElementById('btnSave').addEventListener('click',saveIntervention);
document.getElementById('btnCancel').addEventListener('click',function(){
    if(confirm('√ätes-vous s√ªr de vouloir annuler ? Toutes les donn√©es non sauvegard√©es seront perdues.')){
        // Fermer l'onglet via le parent
        sendToParent('CLOSE_TAB', {
            tabId: currentTabId
        });
    }
});

// Variable globale pour stocker le contenu Gendloc
let gendlocData = null;

// Fonction pour analyser la goutte Gendloc et pr√©-remplir les champs
function analyserGendloc(texte) {
    try {
        // Extraire la commune (ligne 2 g√©n√©ralement)
        const lignes = texte.split('\n');
        
        // Chercher la commune (format: "NOM COMMUNE - XXXXm")
        for (let ligne of lignes) {
            const matchCommune = ligne.match(/^([A-Z√Ä-≈∏\s\-']+)\s*-\s*(\d+)m/);
            if (matchCommune) {
                const commune = matchCommune[1].trim();
                const altitude = matchCommune[2];
                
                // Remplir automatiquement
                const communeInput = document.getElementById('commune');
                const altitudeInput = document.getElementById('altitude');
                
                if (communeInput && !communeInput.value) {
                    communeInput.value = commune;
                    console.log('‚úÖ Commune auto-remplie:', commune);
                }
                
                if (altitudeInput && !altitudeInput.value) {
                    altitudeInput.value = altitude;
                    console.log('‚úÖ Altitude auto-remplie:', altitude);
                }
                
                break;
            }
        }
        
        // Extraire les coordonn√©es D¬∞M'S" et les mettre dans les champs GPS
        const matchDMS = texte.match(/LAT\s*:\s*(\d+)¬∞\s*(\d+)'\s*(\d+)"\s*-\s*LNG\s*:\s*(\d+)¬∞\s*(\d+)'\s*(\d+)"/);
        if (matchDMS) {
            document.getElementById('gpsDMS_LatD').value = matchDMS[1];
            document.getElementById('gpsDMS_LatM').value = matchDMS[2];
            document.getElementById('gpsDMS_LatS').value = matchDMS[3];
            document.getElementById('gpsDMS_LngD').value = matchDMS[4];
            document.getElementById('gpsDMS_LngM').value = matchDMS[5];
            document.getElementById('gpsDMS_LngS').value = matchDMS[6];
            document.getElementById('geolocCheck').checked = true;
            console.log('‚úÖ Coordonn√©es GPS auto-remplies');
        }
        
    } catch (error) {
        console.error('Erreur analyse Gendloc:', error);
    }
}

// Fonction pour obtenir les donn√©es Gendloc (utilis√©e lors de la copie et sauvegarde)
function getGendlocData() {
    return gendlocData;
}

// ===================================
// NOUVELLES FONCTIONNALIT√âS v2
// ===================================

// Affichage temps r√©el des s√©lections m√©t√©o et obstacles
function updateMeteoDisplay() {
    const meteoSelect = document.getElementById('meteo');
    const meteoDisplay = document.getElementById('meteoSelected');
    const selected = Array.from(meteoSelect.selectedOptions).map(opt => opt.value);
    
    if (selected.length === 0) {
        meteoDisplay.innerHTML = '<span style="color: #95a5a6; font-style: italic;">Aucune s√©lection</span>';
    } else {
        meteoDisplay.innerHTML = selected.map(s => `<span class="blessure-badge">${s}</span>`).join(' ');
    }
}

function updateObstaclesDisplay() {
    const obstaclesSelect = document.getElementById('obstacles');
    const obstaclesDisplay = document.getElementById('obstaclesSelected');
    const selected = Array.from(obstaclesSelect.selectedOptions).map(opt => opt.value);
    
    if (selected.length === 0) {
        obstaclesDisplay.innerHTML = '<span style="color: #95a5a6; font-style: italic;">Aucune s√©lection</span>';
    } else {
        obstaclesDisplay.innerHTML = selected.map(s => `<span class="blessure-badge">${s}</span>`).join(' ');
    }
}

function updateAutreSectionDisplay() {
    const autreSectionSelect = document.getElementById('autreSection');
    const autreSectionDisplay = document.getElementById('autreSectionSelected');
    const selected = Array.from(autreSectionSelect.selectedOptions).map(opt => opt.value);
    
    if (selected.length === 0) {
        autreSectionDisplay.innerHTML = '<span style="color: #95a5a6; font-style: italic;">Aucune s√©lection</span>';
    } else {
        autreSectionDisplay.innerHTML = selected.map(s => `<span class="blessure-badge">${s}</span>`).join(' ');
    }
}


    </script>
<script>
// --- D√©partement: gestion "Autre‚Ä¶" ---
(function(){
  const sel = document.getElementById('departement');
  const wrap = document.getElementById('departementAutreWrap');
  if(!sel || !wrap) return;
  function ensureAutreInput(){
    let autre = document.getElementById('departementAutre');
    if(sel.value === 'autre'){
      if(!autre){
        autre = document.createElement('input');
        autre.type = 'text';
        autre.id = 'departementAutre';
        autre.inputMode = 'numeric';
        autre.pattern = '\\d{2,3}';
        autre.maxLength = 3;
        autre.placeholder = 'Saisir n¬∞ de d√©partement (ex: 13)';
        autre.className = 'input';
        autre.style.marginTop = '8px';
        wrap.appendChild(autre);
        autre.focus();
      }
    } else {
      if(autre){ wrap.removeChild(autre); }
    }
  }
  sel.addEventListener('change', ensureAutreInput);
  // init on load
  ensureAutreInput();
})();
</script>
</body>
</html>
