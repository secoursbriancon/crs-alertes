<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRS Alpes Brian√ßon - Alerte Secours</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{--bg:#243244;--panel:#2f4357;--panel-alt:#3a5064;--ink:#eaf0f6;--muted:#a9b7c9;--accent:#e94560;--accent-2:#0f3460;--border:#41576d;--ok:#2ecc71;--warn:#e74c3c;--info:#3499db;--shadow-light: 0 4px 15px rgba(0,0,0,.2);--shadow-bold: 0 10px 30px rgba(0,0,0,.4);}
        body {font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background: linear-gradient(180deg, #1f2a38 0%, var(--bg) 100%);color: var(--ink);padding: 24px;line-height: 1.4;}
        .container {max-width: 1000px;margin: 0 auto;background: var(--panel);border-radius: 14px;padding: 28px;box-shadow: 0 18px 60px rgba(0,0,0,.35);border: 1px solid rgba(255,255,255,.05);}
        h1 {color: var(--accent);font-size: 28px;text-align: center;margin-bottom: 6px;}
        .subtitle {text-align: center;color: var(--muted);font-size: 14px;margin-bottom: 20px;}
        .alert-header {background: linear-gradient(120deg, var(--accent-2), var(--accent));padding: 14px 16px;border-radius: 10px;margin-bottom: 24px;display: flex;justify-content: space-between;align-items: center;}
        .section {background: var(--panel-alt);padding: 20px;border-radius: 12px;margin-bottom: 18px;border: 1px solid var(--border);}
        .section-title {font-size: 20px;font-weight: 900;color: var(--accent);margin-bottom: 18px;padding-bottom: 5px;border-bottom: 2px solid var(--accent);display: inline-block;text-transform: uppercase;letter-spacing: 1px;}
        .form-row-custom { display: grid; gap: 14px; margin-bottom: 14px; }
        .form-row-requerant-1 { grid-template-columns: 220px 1fr; }
        .form-row-requerant-2 { grid-template-columns: 1fr 1fr; }
        .form-row-intervention { grid-template-columns: 1fr 1fr; }
        .form-row-lieu { grid-template-columns: 1fr 1.2fr 120px; }
        .form-row-victime { grid-template-columns: 140px 110px 1.5fr; }
        .form-row-moyens { grid-template-columns: 1fr 1fr; }
        label {color: var(--muted);font-size: 12px;font-weight: 700;margin-bottom: 6px;text-transform: uppercase;}
        input[type="text"], input[type="number"], input[type="tel"], textarea, select {background: #1b2735;border: 1px solid var(--border);border-radius: 10px;padding: 10px 12px;color: var(--ink);font-size: 14px;width: 100%;}
        .form-group {display: flex;flex-direction: column;}
        .checkbox-group {display: flex;gap: 15px;align-items: center;margin-top: 10px;}
        .checkbox-label {display: flex;align-items: center;font-size: 14px;font-weight: 500;color: var(--ink);}
        .phone-group {display: flex;gap: 8px;align-items: flex-end;}
        .phone-group-inner {display: flex;flex-grow: 1;gap: 8px;}
        .phone-group-inner input {flex-grow: 1;}
        .country-code-select {background: #1b2735;border: 1px solid var(--border);border-radius: 10px;padding: 10px 6px;color: var(--ink);font-size: 14px;height: 40px;text-align: center;width: 110px;}
        .btn-add-phone, .btn-remove-phone {width: 40px;height: 40px;border-radius: 10px;font-size: 20px;font-weight: bold;border: none;cursor: pointer;transition: background 0.2s;box-shadow: var(--shadow-light);color: #fff;flex-shrink: 0;display: flex;justify-content: center;align-items: center;}
        .btn-add-phone {background: var(--ok);}
        .btn-remove-phone {background: var(--warn);}
        .gps-group {display: flex;align-items: center;gap: 2px;margin-top: 5px;}
        .gps-group input {text-align: right;padding: 6px 6px;height: 30px;font-size: 13px;max-width: 45px;flex-grow: 1;}
        #sectionLocalisation input[maxlength="2"] {max-width: 35px;}
        #sectionLocalisation input[maxlength="5"] {max-width: 50px;}
        .gps-group span {font-size: 14px;color: var(--muted);font-weight: 500;}
        .moyens-volants-terrestres {display: flex;gap: 20px;margin-bottom: 10px;}
        .secouristes-grid {display: flex;flex-wrap: wrap;gap: 8px 15px;margin-top: 8px;line-height: 1.2;}
        .btn {border: none;padding: 10px 18px;border-radius: 12px;cursor: pointer;font-size: 14px;font-weight: 800;box-shadow: var(--shadow-light);transition: all 0.2s ease;}
        .btn:hover { box-shadow: var(--shadow-bold); transform: translateY(-2px); }
        .btn-green { background: var(--ok); color: #fff; }
        .btn-red {background: var(--warn);color: #fff;padding: 6px 12px;font-size: 12px;border-radius: 8px;height: 30px;display: flex;align-items: center;}
        .actions { display: flex; gap: 12px; justify-content: center; margin-top: 26px; }
        .section-nav {display: flex;justify-content: flex-end;align-items: center;gap: 20px;margin-top: 12px;padding-top: 12px;border-top: 1px dashed var(--border);}
        .btn-copy {background: var(--info);color: #fff;border: 1px solid var(--info);padding: 10px 18px;border-radius: 12px;font-size: 14px;font-weight: 800;box-shadow: var(--shadow-light);transition: all 0.2s ease;}
        .btn-copy:hover { box-shadow: var(--shadow-bold); transform: translateY(-2px); }
        .nav-actions {display: flex;gap: 10px;}
        .btn-arrow {width: 40px;height: 40px;display: flex;justify-content: center;align-items: center;border-radius: 50%;font-size: 18px;font-weight: 900;color: #fff;border: none;cursor: pointer;box-shadow: var(--shadow-light);transition: all 0.2s ease;}
        .btn-arrow:hover { box-shadow: var(--shadow-bold); transform: scale(1.05); }
        .btn-return { background: var(--warn); }
        .btn-next { background: var(--ok); }
        .section { position: relative; }
        .btn-return-top { position: absolute; top: 12px; right: 12px; z-index: 2; }
        #copyConfirmation, #saveConfirmation {position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);background: rgba(46, 204, 113, 0.95);color: white;padding: 15px 30px;border-radius: 10px;font-weight: bold;font-size: 18px;z-index: 1000;box-shadow: 0 0 20px rgba(0,0,0,0.5);opacity: 0;transition: opacity 0.2s ease;}
        .victim-card {background: #26384a;padding: 14px;border-radius: 12px;margin-bottom: 14px;border: 1px solid var(--border);}
        .blessures-row {display: flex;gap: 14px;align-items: flex-start;}
        .blessures-row select {flex-basis: 65%;min-width: 250px;}
        .blessures-row .form-group {flex-basis: 35%;flex-grow: 1;}
        .blessures-selected {background: #2a3a4b;padding: 8px 12px;border-radius: 10px;margin-bottom: 8px;min-height: 34px;color: var(--ok);font-size: 13px;font-weight: 700;border: 1px solid var(--border);line-height: 1.2;}
        .blessures-selected:empty::before {content: "Aucune blessure s√©lectionn√©e";color: #95a5a6;font-style: italic;font-weight: 500;}
        .victim-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 10px;}
        .status-banner {background: rgba(46, 204, 113, 0.2);border: 1px solid var(--ok);border-radius: 10px;padding: 10px 15px;margin-bottom: 20px;text-align: center;font-size: 14px;}
        .status-banner.error {background: rgba(231, 76, 60, 0.2);border-color: var(--warn);}
        .phone-name-input {background: #1b2735;border: 1px solid var(--border);border-radius: 10px;padding: 10px 12px;color: var(--ink);font-size: 14px;min-width: 150px;max-width: 200px;flex-grow: 1;}
        .phone-group-inner input.phone-input {min-width: 180px;flex-grow: 2;}
        .blessure-badge{display:inline-block;margin:2px 6px 2px 0;padding:4px 8px;border-radius:10px;background:#1f8f5a;color:#eafff4;font-weight:700;font-size:12px;}
    </style>
</head>
<body>
    <div class="container">
        <div class="status-banner" id="statusBanner" style="display:none;"></div>
        
        <section class="section requerant" id="sectionRequerant" data-section-name="Requ√©rant">
            <div class="section-title">üë§ Requ√©rant</div>
            <div class="form-row-custom form-row-requerant-1">
                <div class="form-group" data-field="Origine de l'alerte">
                    <label>Origine de l'alerte</label>
                    <select id="origineAlerte"><option value="">S√©lectionner...</option></select>
                </div>
            </div>
            <div class="form-group" data-field="T√©l√©phones">
                <label>T√©l√©phone(s) et nom(s)</label>
                <div id="phonesContainer">
                    <div class="phone-group">
                        <div class="phone-group-inner">
                            <select class="country-code-select"></select>
                            <input type="tel" class="phone-input" placeholder="06 12 34 56 78" maxlength="14" inputmode="tel" autocomplete="tel">
                        </div>
                        <input type="text" class="phone-name-input" placeholder="Nom du requ√©rant" style="flex-grow: 1;" maxlength="25">
                        <button type="button" class="btn-add-phone">+</button>
                    </div>
                </div>
            </div>
            <div class="form-group" data-field="Infos requ√©rant">
                <label>Informations requ√©rant</label>
                <input type="text" id="infosRequerant" placeholder="Informations compl√©mentaires">
            </div>
            <div class="form-row-custom form-row-intervention">
                
                <div class="form-group" data-field="Activit√©">
                    <label>Activit√© pratiqu√©e</label>
                    <select id="activite"><option value="">S√©lectionner...</option></select>
                </div>
            </div>
            <div class="section-nav">
                <button type="button" class="btn-copy" data-section="sectionRequerant">Copier l'alerte</button>
                <div class="nav-actions"><button type="button" class="btn-arrow btn-next" data-target="sectionLocalisation">‚Üì</button></div>
            </div>
        </section>

        <section class="section localisation" id="sectionLocalisation" data-section-name="Localisation">
            <div class="section-title">üìç Localisation</div>
            <button type="button" class="btn-arrow btn-return btn-return-top" data-target="sectionRequerant">‚Üë</button>
            <div class="form-row-custom form-row-lieu">
                <div class="form-group" data-field="D√©partement">
                    <label>D√©partement</label>
                    <select id="departement">
                        <option value="05" selected>05 ‚Äì Hautes-Alpes</option>
                        <option value="38">38 ‚Äì Is√®re</option>
                        <option value="73">73 ‚Äì Savoie</option>
                        <option value="04">04 ‚Äì Alpes-de-Haute-Provence</option>
                        <option value="autre">Autre‚Ä¶</option>
                    </select>
                    <div id="departementAutreWrap"></div>
                </div>
                <div class="form-group" data-field="Commune">
                    <label>Commune</label>
                    <input type="text" id="commune" placeholder="Taper pour rechercher..." list="communesList">
                    <datalist id="communesList"></datalist>
                </div>
                <div class="form-group" data-field="Altitude">
                    <label>Altitude (m)</label>
                    <input type="number" id="altitude" class="altitude" placeholder="2500">
                </div>
            </div>
            <div class="form-group" data-field="Lieu exact (ou coller contenu goute Gendloc)">
                <label>Lieu exact (ou coller contenu goute Gendloc ctrl+v)</label>
                <textarea id="lieuExact" placeholder="Description pr√©cise du lieu"></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 10px;">
                <div class="form-group">
                    <label><input type="checkbox" id="geolocCheck" style="width:auto;margin-right:8px;"> GPS</label>
                    <div style="margin-bottom: 8px;">
                        <small style="color: #95a5a6;">Coller coordonn√©es :</small>
                        <input type="text" id="gpsPaste" placeholder="45¬∞ 3' 49&quot; - LNG : 6¬∞ 38' 43&quot;" style="margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 8px;">
                        <small style="color: #95a5a6;">Latitude :</small>
                        <div class="gps-group">
                            <input type="text" id="gpsLatD" placeholder="45" maxlength="2"><span>¬∞</span>
                            <input type="text" id="gpsLatM" placeholder="30" maxlength="2"><span>'</span>
                            <input type="text" id="gpsLatS" placeholder="15" maxlength="5"><span>"</span>
                        </div>
                    </div>
                    <div>
                        <small style="color: #95a5a6;">Longitude :</small>
                        <div class="gps-group">
                            <input type="text" id="gpsLngD" placeholder="6" maxlength="2"><span>¬∞</span>
                            <input type="text" id="gpsLngM" placeholder="45" maxlength="2"><span>'</span>
                            <input type="text" id="gpsLngS" placeholder="30" maxlength="5"><span>"</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="amlCheck" style="width:auto;margin-right:8px;"> AML</label>
                    <div style="margin-bottom: 8px;">
                        <small style="color: #95a5a6;">Coller coordonn√©es :</small>
                        <input type="text" id="amlPaste" placeholder="44¬∞ 54' 12&quot; - 6¬∞ 23' 53&quot;" style="margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 8px;">
                        <small style="color: #95a5a6;">Latitude :</small>
                        <div class="gps-group">
                            <input type="text" id="amlLatD" placeholder="45" maxlength="2"><span>¬∞</span>
                            <input type="text" id="amlLatM" placeholder="30" maxlength="2"><span>'</span>
                            <input type="text" id="amlLatS" placeholder="15" maxlength="5"><span>"</span>
                        </div>
                    </div>
                    <div>
                        <small style="color: #95a5a6;">Longitude :</small>
                        <div class="gps-group">
                            <input type="text" id="amlLngD" placeholder="6" maxlength="2"><span>¬∞</span>
                            <input type="text" id="amlLngM" placeholder="45" maxlength="2"><span>'</span>
                            <input type="text" id="amlLngS" placeholder="30" maxlength="5"><span>"</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section-nav">
                <button type="button" class="btn-copy" data-section="sectionLocalisation">Copier l'alerte</button>
                <div class="nav-actions">
                    <button type="button" class="btn-arrow btn-next" data-target="sectionVictimes">‚Üì</button>
                </div>
            </div>
        </section>

        <section class="section victimes" id="sectionVictimes" data-section-name="Victime(s)">
            <div class="section-title">üöë Victime(s)</div>
            <button type="button" class="btn-arrow btn-return btn-return-top" data-target="sectionLocalisation">‚Üë</button>
            <div id="victimesContainer">
                <div class="victim-card" id="victim-1">
                    <div class="victim-header"><h4>Victime 1</h4></div>
                    <div class="form-row-custom form-row-victime">
                        <div class="form-group" data-field="Sexe">
                            <label>Sexe</label>
                            <select class="select-sexe">
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                            </select>
                        </div>
                        <div class="form-group" data-field="√Çge">
                            <label>√Çge</label>
                            <input type="number" class="input-age" placeholder="25">
                        </div>
                        <div class="form-group" data-field="Circonstances">
                            <label>Circonstances</label>
                            <select class="select-circonstances"><option value="">S√©lectionner...</option></select>
                        </div>
                    </div>
                    <div class="form-group victim-blessures-group">
                        <label>Blessures (Ctrl pour s√©lection multiple)</label>
                        <div class="blessures-selected" id="blessuresSelected1"></div>
                        <div class="blessures-row">
                            <select multiple size="5" id="blessures1" class="select-blessures"></select>
                            <div class="form-group" data-field="Autre blessure" style="flex-grow: 1;">
                                <label style="margin-top: 0;">Autre blessure</label>
                                <input type="text" placeholder="Description libre..." class="blessure-autre-input">
                            </div>
                        </div>
                    </div>
                    <div class="form-group" data-field="Infos compl√©mentaires" style="margin-top: 15px;">
                        <label>Informations compl√©mentaires</label>
                        <textarea placeholder="Infos suppl√©mentaires..." rows="2" class="victim-infos-comp"></textarea>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-green" id="btnAddVictim">+ Ajouter une victime</button>
            <div class="section-nav">
                <button type="button" class="btn-copy" data-section="sectionVictimes">Copier l'alerte</button>
                <div class="nav-actions">
                    <button type="button" class="btn-arrow btn-next" data-target="sectionMoyens">‚Üì</button>
                </div>
            </div>
        </section>

        <section class="section moyens" id="sectionMoyens" data-section-name="Moyens engag√©s">
            <div class="section-title">üöÅ Moyens engag√©s</div>
            <button type="button" class="btn-arrow btn-return btn-return-top" data-target="sectionVictimes">‚Üë</button>
            <div class="moyens-wrap">
                <div class="moyens-top" data-field="Moyens">
                    <div class="moyens-volants-terrestres">
                        <label class="checkbox-label"><input type="checkbox" id="choucas05" value="CHOUCAS 05"> CHOUCAS&nbsp;05</label>
                        <label class="checkbox-label"><input type="checkbox" id="equipeTerrestre" value="√âquipe terrestre"> √âquipe&nbsp;terrestre</label>
                    </div>
                    <div class="moyens-medicaux" style="margin-top: 5px;">
                        <label class="checkbox-label"><input type="checkbox" id="secoursMed" value="Secours m√©dicalis√©"> Secours m√©dicalis√©</label>
                    </div>
                </div>
            </div>
            <div class="form-row-custom form-row-moyens" style="margin-top: 14px;">
                <div class="form-group" data-field="M√©t√©o">
                    <label>M√©t√©o (Ctrl pour multiple)</label>
                    <select multiple size="4" id="meteo">
                        <option>Beau</option><option>Nuages</option><option>Brouillard</option>
                        <option>Neigeux</option><option>Vent</option><option>Orage</option>
                    </select>
                </div>
                <div class="form-group" data-field="Obstacles">
                    <label>Obstacles (Ctrl pour multiple)</label>
                    <select multiple size="4" id="obstacles">
                        <option>Aucun</option><option>Ligne √©lectrique</option><option>Remont√©es m√©caniques</option>
                        <option>C√¢ble √† bois</option><option>Parapentes</option>
                    </select>
                </div>
            </div>
            <div class="form-group" data-field="Secouristes" style="margin-top: 12px;">
                <label>Secouristes engag√©s</label>
                <div class="secouristes-grid" id="secouristesGrid"></div>
            </div>
            <div class="form-group" data-field="Infos moyens" style="margin-top: 12px;">
                <label>Informations compl√©mentaires</label>
                <textarea id="infosMoyens" placeholder="Autres informations..."></textarea>
            </div>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="infosMoyensImportant" style="margin-right:8px;"> IMPORTANT
                </label>
            </div>
            <div class="section-nav">
                <button type="button" class="btn-copy" data-section="sectionMoyens">Copier l'alerte</button>
                <div class="nav-actions"></div>
            </div>
        </section>

        <div class="actions">
            <button type="button" class="btn" style="background: #6c757d; color: #fff;" id="btnCancel">Annuler</button>
            <button type="button" class="btn btn-green" id="btnSave">üöÅ Cr√©er l'intervention</button>
        </div>
    </div>
    
    <div id="copyConfirmation">Donn√©es copi√©es! coller ctrl+v</div>
    <div id="saveConfirmation">Intervention cr√©√©e!</div>

    <script>
// ===================================================
// COMMUNICATION AVEC LE SYST√àME D'ONGLETS (PARENT)
// ===================================================
let currentTabId = null;
let currentTabData = null;

// R√©cup√©rer l'ID de l'onglet depuis l'URL
const urlParams = new URLSearchParams(window.location.search);
currentTabId = urlParams.get('tabId');

// √âcouter les messages du parent
window.addEventListener('message', function(event) {
    if (event.data.type === 'INIT_TAB') {
        currentTabData = event.data.tabData;
        console.log('üì• Donn√©es onglet re√ßues:', currentTabData);
        
        // Restaurer les donn√©es locales si elles existent
        if (currentTabData.donneesLocales && Object.keys(currentTabData.donneesLocales).length > 0) {
            restaurerDonnees(currentTabData.donneesLocales);
        }
    }
});

// Fonction pour envoyer un message au parent
function sendToParent(type, data) {
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type, data }, '*');
    }
}

// Fonction pour restaurer les donn√©es du formulaire
function restaurerDonnees(donnees) {
    // Impl√©menter la restauration des donn√©es si besoin
    console.log('Restauration donn√©es:', donnees);
}

// Fonction pour sauvegarder automatiquement les donn√©es localement
function sauvegarderLocal() {
    if (!currentTabId) return;
    
    const donnees = {
        origine_alerte: document.getElementById('origineAlerte')?.value,
        activite: document.getElementById('activite')?.value,
        commune: document.getElementById('commune')?.value,
        // ... autres champs selon besoin
    };
    
    sendToParent('UPDATE_TAB', {
        tabId: currentTabId,
        updates: {
            donneesLocales: donnees
        }
    });
}

// Sauvegarder automatiquement toutes les 30 secondes
setInterval(sauvegarderLocal, 30000);

    </script>
    <script>
const SUPABASE_URL='https://vnasjoncvlupdswupfzk.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuYXNqb25jdmx1cGRzd3VwZnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NDQ0MDUsImV4cCI6MjA3NjAyMDQwNX0.2j1_qtxv8giF_HfspdY6XxyOLJYoR6xaSnfi_b2BQ3w';
let supabase,isSupabaseConfigured=false,countryCodes=[],phoneCount=1,victimCount=1,communesCache={};
const ALERT_NUMBER=1;

try{
    const{createClient}=window.supabase;
    supabase=createClient(SUPABASE_URL,SUPABASE_KEY);
    isSupabaseConfigured=true;
    console.log('‚úÖ Supabase connect√©');
    supabase.from('origines_alerte').select('count').limit(1).then(({data,error})=>{
        if(error){console.error('‚ùå Erreur:',error);showStatus('‚ö†Ô∏è Erreur de connexion',true);}
        else{console.log('‚úÖ Test connexion OK');}
    });
}catch(error){
    console.error('‚ùå Erreur init:',error);
    showStatus('‚ö†Ô∏è Erreur initialisation',true);
}

function showStatus(message,isError){
    const banner=document.getElementById('statusBanner');
    banner.textContent=message;
    banner.className='status-banner'+(isError?' error':'');
    banner.style.display='block';
    setTimeout(()=>{banner.style.display='none';},5000);
}

async function loadCallingCodes(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('calling_codes').select('code, country_name, flag_emoji, phone_format').order('country_name');
        if(error)throw error;
        countryCodes=data.map(item=>({code:item.code,name:`${item.flag_emoji||''} ${item.country_name}`.trim(),placeholder:item.phone_format||'XX XXX XXXX'}));
        const franceIndex=countryCodes.findIndex(c=>c.code==='+33');
        if(franceIndex>-1){const france=countryCodes.splice(franceIndex,1)[0];countryCodes.unshift(france);}
        console.log('‚úÖ Indicatifs:',countryCodes.length);
    }catch(error){
        console.error('Erreur indicatifs:',error);
        countryCodes=[{code:'+33',name:'üá´üá∑ France',placeholder:'06 12 34 56 78'},{code:'+41',name:'üá®üá≠ Suisse',placeholder:'XX XXX XX XX'}];
    }
}

async function loadOriginesAlerte(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('origines_alerte').select('nom').order('ordre');
        if(error)throw error;
        const select=document.getElementById('origineAlerte');
        data.forEach(item=>{const option=document.createElement('option');option.value=item.nom;option.textContent=item.nom;select.appendChild(option);});
        console.log('‚úÖ Origines:',data.length);
    }catch(error){console.error('Erreur origines:',error);}
}

async function loadActivites(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('activites').select('nom').order('nom');
        if(error)throw error;
        const select=document.getElementById('activite');
        data.forEach(item=>{const option=document.createElement('option');option.value=item.nom;option.textContent=item.nom;select.appendChild(option);});
        console.log('‚úÖ Activit√©s:',data.length);
    }catch(error){console.error('Erreur activit√©s:',error);}
}

async function loadCirconstances(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('circonstances').select('nom').order('nom');
        if(error)throw error;
        document.querySelectorAll('.select-circonstances').forEach(select=>{
            select.innerHTML='<option value="">S√©lectionner...</option>';
            data.forEach(item=>{const option=document.createElement('option');option.value=item.nom;option.textContent=item.nom;select.appendChild(option);});
        });
        console.log('‚úÖ Circonstances:',data.length);
    }catch(error){console.error('Erreur circonstances:',error);}
}

async function loadBlessures(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('blessures').select('nom').order('nom');
        if(error)throw error;
        document.querySelectorAll('.select-blessures').forEach(select=>{
            select.innerHTML='';
            data.forEach(item=>{const option=document.createElement('option');option.value=item.nom;option.textContent=item.nom;select.appendChild(option);});
            const victimCard = select.closest('.victim-card');
            if(victimCard){
                const victimId = victimCard.id.split('-')[1];
                const selectedDiv = document.getElementById('blessuresSelected' + victimId);
                if(selectedDiv){
                    setupBlessuresSelect(select, selectedDiv);
                }
            }
        });
        console.log('‚úÖ Blessures:',data.length);
    }catch(error){console.error('Erreur blessures:',error);}
}

async function loadSecouristes(){
    if(!isSupabaseConfigured)return;
    try{
        const{data,error}=await supabase.from('secouristes').select('nom').eq('actif',true).order('nom');
        if(error)throw error;
        const grid=document.getElementById('secouristesGrid');
        grid.innerHTML='';
        data.forEach(item=>{const label=document.createElement('label');label.className='checkbox-label';label.innerHTML=`<input type="checkbox" value="${item.nom}"> ${item.nom}`;grid.appendChild(label);});
        console.log('‚úÖ Secouristes:',data.length);
    }catch(error){console.error('Erreur secouristes:',error);}
}

async function saveIntervention(){
    if(!isSupabaseConfigured){alert('‚ö†Ô∏è Supabase non configur√©');return;}
    
    // Validation des champs obligatoires
    const commune = document.getElementById('commune').value;
    if (!commune) {
        alert('‚ö†Ô∏è Veuillez renseigner la commune');
        document.getElementById('commune').focus();
        return;
    }
    
    try{
        const interventionData={
            date_alerte:new Date().toISOString(),
            numero_alerte:parseInt(document.getElementById('alertNumber')?.textContent || ALERT_NUMBER),
            origine_alerte:document.getElementById('origineAlerte').value,
            telephones:Array.from(document.querySelectorAll('#phonesContainer .phone-group')).map(group=>{
                const code=group.querySelector('.country-code-select').value;
                const num=group.querySelector('.phone-input').value.trim();
                const nom=group.querySelector('.phone-name-input').value.trim();
                return num?`${code} ${num}${nom?' ('+nom+')':''}`:'';
            }).filter(v=>v).join(' / '),
            infos_requerant:document.getElementById('infosRequerant').value,
            type_intervention:(document.querySelector('input[name=\"typeIntervention\"]:checked')?.value || null),
            activite:document.getElementById('activite').value,
            departement:document.getElementById('departement').value,
            commune:document.getElementById('commune').value,
            altitude:document.getElementById('altitude').value?parseInt(document.getElementById('altitude').value):null,
            lieu_exact:document.getElementById('lieuExact').value,
            gps_actif:document.getElementById('geolocCheck').checked,
            gps_lat_d:document.getElementById('gpsLatD').value,
            gps_lat_m:document.getElementById('gpsLatM').value,
            gps_lat_s:document.getElementById('gpsLatS').value,
            gps_lng_d:document.getElementById('gpsLngD').value,
            gps_lng_m:document.getElementById('gpsLngM').value,
            gps_lng_s:document.getElementById('gpsLngS').value,
            aml_actif:document.getElementById('amlCheck').checked,
            aml_lat_d:document.getElementById('amlLatD').value,
            aml_lat_m:document.getElementById('amlLatM').value,
            aml_lat_s:document.getElementById('amlLatS').value,
            aml_lng_d:document.getElementById('amlLngD').value,
            aml_lng_m:document.getElementById('amlLngM').value,
            aml_lng_s:document.getElementById('amlLngS').value,
            choucas_05:document.getElementById('choucas05').checked,
            equipe_terrestre:document.getElementById('equipeTerrestre').checked,
            secours_medicalise:document.getElementById('secoursMed').checked,
            meteo:Array.from(document.getElementById('meteo').selectedOptions).map(opt=>opt.text).join(', '),
            obstacles:Array.from(document.getElementById('obstacles').selectedOptions).map(opt=>opt.text).join(', '),
            secouristes:Array.from(document.querySelectorAll('#secouristesGrid input[type="checkbox"]:checked')).map(cb=>cb.value).join(', '),
            infos_moyens:document.getElementById('infosMoyens').value,
            // Nouveaux champs pour le syst√®me multi-onglets
            statut:'intervention_en_cours',
            utilisateur:localStorage.getItem('nom_utilisateur') || 'Utilisateur',
            titre_onglet:commune + ' - ' + new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
            onglet_couleur:'green'
        };
        
        const{data:intervention,error:interventionError}=await supabase.from('interventions').insert([interventionData]).select().single();
        if(interventionError)throw interventionError;
        
        const victimes=[];
        document.querySelectorAll('#victimesContainer .victim-card').forEach((card,index)=>{
            const selectedBlessures=Array.from(card.querySelector('.select-blessures').selectedOptions).map(opt=>opt.text).join(', ');
            const autreBlessure=card.querySelector('.blessure-autre-input').value.trim();
            victimes.push({
                intervention_id:intervention.id,
                numero_victime:index+1,
                sexe:card.querySelector('.select-sexe').value,
                age:card.querySelector('.input-age').value?parseInt(card.querySelector('.input-age').value):null,
                circonstances:card.querySelector('.select-circonstances').value,
                blessures:selectedBlessures,
                autre_blessure:autreBlessure,
                infos_complementaires:card.querySelector('.victim-infos-comp').value
            });
        });
        
        if(victimes.length>0){
            const{error:victimesError}=await supabase.from('victimes').insert(victimes);
            if(victimesError)throw victimesError;
        }
        
        showSaveConfirmation();
        console.log('‚úÖ Intervention cr√©√©e:',intervention.id);
        
        // Notifier le parent pour basculer vers le formulaire terrain
        sendToParent('UPDATE_TAB', {
            tabId: currentTabId,
            updates: {
                interventionId: intervention.id,
                titre: intervention.titre_onglet,
                statut: 'intervention_en_cours',
                couleur: 'green',
                phase: 'terrain'
            }
        });
        
        sendToParent('SHOW_NOTIFICATION', {
            message: '‚úÖ Intervention cr√©√©e - Basculement vers le formulaire terrain',
            level: 'info'
        });
        
        // Attendre 1 seconde avant de basculer pour laisser voir la confirmation
        setTimeout(() => {
            sendToParent('SWITCH_PHASE', {
                tabId: currentTabId,
                phase: 'terrain'
            });
        }, 1000);
        
    }catch(error){console.error('Erreur:',error);alert('‚ùå Erreur : '+error.message);}
}

function showSaveConfirmation(){const conf=document.getElementById('saveConfirmation');conf.style.opacity=1;setTimeout(()=>{conf.style.opacity=0;},2000);}

(async function init(){
    const now=new Date();
    console.log('üöÄ D√©marrage...');
    
    await Promise.all([loadCallingCodes(),loadOriginesAlerte(),loadActivites(),loadCirconstances(),loadBlessures(),loadSecouristes()]);
    
    const firstPhoneGroup = document.querySelector('#phonesContainer .phone-group');
    if(firstPhoneGroup) {
        setupPhoneGroup(firstPhoneGroup);
    }
    
    const initialDep=document.getElementById('departement').value;
    const communes=await loadCommunes(initialDep);
    updateCommunesList(communes);
    
    console.log('‚úÖ App OK');
})();

const phonesContainer=document.getElementById('phonesContainer');
function populateCountryCodes(selectElement){
    selectElement.innerHTML='';
    if(countryCodes.length===0){const option=document.createElement('option');option.value='+33';option.textContent='üá´üá∑ France (+33)';selectElement.appendChild(option);}
    else{countryCodes.forEach(country=>{const option=document.createElement('option');option.value=country.code;option.textContent=`${country.name} (${country.code})`;selectElement.appendChild(option);});}
    selectElement.value='+33';
}

function updatePlaceholder(selectElement){
    const group = selectElement ? selectElement.closest('.phone-group-inner') : null;
    const inputElement = group ? group.querySelector('.phone-input') : null;
    if(!inputElement || !selectElement){ return; }
    const code=selectElement.value;
    const country=countryCodes.find(c=>c.code===code);
    inputElement.placeholder=country?country.placeholder:'Num√©ro';
    if(code === '+33'){
        inputElement.value = formatFrenchMobile(inputElement.value);
        inputElement.maxLength = 14;
    } else {
        inputElement.value = digitsOnly(inputElement.value).slice(0,20);
        inputElement.maxLength = 23;
    }
}

function setupPhoneGroup(group){
    if(!group) return;
    const select=group.querySelector('.country-code-select');
    const input=group.querySelector('.phone-input');
    if(!select || !input) return;
    populateCountryCodes(select);
    updatePlaceholder(select);
    select.addEventListener('change',()=>updatePlaceholder(select));
    input.addEventListener('input',formatPhone);
    input.addEventListener('paste',handlePhonePaste);
    input.addEventListener('blur',()=>{
        const code = select.value;
        if(code === '+33' && input.value.trim()!==''){
            if(!isValidFrenchMobile(input.value)){
                input.setCustomValidity('Num√©ro fran√ßais invalide (ex: 06 12 34 56 78)');
            } else {
                input.setCustomValidity('');
            }
        } else {
            input.setCustomValidity('');
        }
    });
}

function digitsOnly(s){ return (s||'').replace(/[\u00A0\s\-.]/g,'').replace(/\D/g,''); }

function formatFrenchMobile(val){
    let d = digitsOnly(val).slice(0,10);
    let out = '';
    for(let i=0;i<d.length;i++){
        if(i>0 && i%2===0) out+=' ';
        out += d[i];
    }
    return out;
}

function formatPhone(e){
    const code=e.target.closest('.phone-group-inner').querySelector('.country-code-select').value;
    if(code==='+33'){
        let val=e.target.value.replace(/\D/g,'');
        if(val.length>10)val=val.substring(0,10);
        let formatted='';
        for(let i=0;i<val.length;i++){if(i>0&&i%2===0)formatted+=' ';formatted+=val[i];}
        e.target.value=formatted;
        e.target.maxLength=14;
    }else{
        let val=e.target.value.replace(/[^\d\s]/g,'');
        if(val.length>20)val=val.substring(0,20);
        e.target.value=val;
        e.target.maxLength=20;
    }
}

function handlePhonePaste(e){
    const input = e.target;
    const group = input.closest('.phone-group-inner');
    if(!group) return;
    const code = group.querySelector('.country-code-select')?.value || '+33';
    let text = (e.clipboardData || window.clipboardData).getData('text');
    if(!text) return;
    e.preventDefault();
    if(code === '+33'){
        input.value = formatFrenchMobile(text);
        input.maxLength = 14;
    }else{
        let clean = digitsOnly(text).slice(0,20);
        let chunks = [];
        while(clean.length){
            if(clean.length > 4) { chunks.push(clean.slice(0,3)); clean = clean.slice(3); }
            else { chunks.push(clean); clean=''; }
        }
        input.value = chunks.join(' ');
        input.maxLength = 23;
    }
}

function isValidFrenchMobile(val){
    const d = digitsOnly(val);
    return /^0\d{9}$/.test(d);
}

document.querySelector('.btn-add-phone').addEventListener('click',function(){
    if(phoneCount>=3){alert('Maximum 3 num√©ros');return;}
    phoneCount++;
    const div=document.createElement('div');
    div.className='phone-group';
    div.style.marginTop='8px';
    div.innerHTML='<div class="phone-group-inner"><select class="country-code-select"></select><input type="tel" class="phone-input" placeholder="06 12 34 56 78" maxlength="14" inputmode="tel" autocomplete="tel"></div><input type="text" class="phone-name-input" placeholder="Nom du requ√©rant" style="flex-grow: 1;" maxlength="25"><button type="button" class="btn-remove-phone">‚àí</button>';
    phonesContainer.appendChild(div);
    setupPhoneGroup(div);
    div.querySelector('.btn-remove-phone').addEventListener('click',function(){div.remove();phoneCount--;});
});

document.querySelectorAll('.btn-arrow').forEach(btn=>{btn.addEventListener('click',function(){const target=this.getAttribute('data-target');if(target){document.getElementById(target).scrollIntoView({behavior:'smooth',block:'start'});}});});

async function loadCommunes(dep){
    if(communesCache[dep])return communesCache[dep];
    try{
        const res=await fetch(`https://geo.api.gouv.fr/departements/${dep}/communes?fields=nom`);
        const data=await res.json();
        data.sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'}));
        communesCache[dep]=data;
        return data;
    }catch(err){console.error('Erreur communes:',err);return[];}
}

function normalizeText(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

function updateCommunesList(communes,filterTerm=''){
    const dl=document.getElementById('communesList');
    dl.innerHTML='';
    const normTerm = normalizeText(filterTerm);
    const communesToDisplay = normTerm
        ? communes.filter(c => normalizeText(c.nom).startsWith(normTerm))
        : communes;
    communesToDisplay.forEach(c=>{const opt=document.createElement('option');opt.value=c.nom;dl.appendChild(opt);});
}

const departementSelect=document.getElementById('departement');
const communeInput=document.getElementById('commune');
departementSelect.addEventListener('change',async function(){const dep=this.value;const communes=await loadCommunes(dep);updateCommunesList(communes);communeInput.value='';});
communeInput.addEventListener('input',async function(){const term=this.value;const dep=departementSelect.value;const communes=await loadCommunes(dep);updateCommunesList(communes,term);});

function parseAndFillGPS(pasteValue,prefix){
    const regex=/(\d+)\s*[¬∞¬∫]\s*(\d+)'\s*([\d\.]*)"?\s*.*?(\d+)\s*[¬∞¬∫]\s*(\d+)'\s*([\d\.]*)"?/i;
    const match=pasteValue.match(regex);
    if(match){
        const[,latD,latM,latS,lngD,lngM,lngS]=match;
        document.getElementById(prefix+'LatD').value=latD.trim();
        document.getElementById(prefix+'LatM').value=latM.trim();
        document.getElementById(prefix+'LatS').value=parseFloat(latS).toFixed(2).replace(/\.00$/,'').replace(/^0\./,'.')||'0';
        document.getElementById(prefix+'LngD').value=lngD.trim();
        document.getElementById(prefix+'LngM').value=lngM.trim();
        document.getElementById(prefix+'LngS').value=parseFloat(lngS).toFixed(2).replace(/\.00$/,'').replace(/^0\./,'.')||'0';
    }else{alert("Format non reconnu");}
}

document.getElementById('gpsPaste').addEventListener('input',function(){parseAndFillGPS(this.value,'gps');});
document.getElementById('amlPaste').addEventListener('input',function(){parseAndFillGPS(this.value,'aml');});

function setupBlessuresSelect(selectElement,selectedDivElement){
    if(!(selectElement&&selectedDivElement)) return;
    const otherInput = selectElement.closest('.blessures-row')?.querySelector('.blessure-autre-input');

    function render(){
        const labels = Array.from(selectElement.selectedOptions).map(o=>o.text.trim()).filter(Boolean);
        const other = (otherInput && otherInput.value.trim()) ? otherInput.value.trim() : null;
        const items = other ? [...labels, other] : labels;
        selectedDivElement.innerHTML = items.length
            ? items.map(txt=>`<span class="blessure-badge">${txt}</span>`).join(' ')
            : '';
    }

    selectElement.addEventListener('change', render);
    if(otherInput){
        otherInput.addEventListener('input', render);
    }
    render();
}

const victimesContainer=document.getElementById('victimesContainer');
const btnAddVictim=document.getElementById('btnAddVictim');

function createVictimCard(index){
    const card=document.createElement('div');
    card.className='victim-card';
    card.id=`victim-${index}`;
    card.innerHTML=`<div class="victim-header"><h4>Victime ${index}</h4><button type="button" class="btn-red btn-remove-victim">Supprimer</button></div><div class="form-row-custom form-row-victime"><div class="form-group" data-field="Sexe"><label>Sexe</label><select class="select-sexe"><option value="Homme">Homme</option><option value="Femme">Femme</option></select></div><div class="form-group" data-field="√Çge"><label>√Çge</label><input type="number" class="input-age" placeholder="25"></div><div class="form-group" data-field="Circonstances"><label>Circonstances</label><select class="select-circonstances"><option value="">S√©lectionner...</option></select></div></div><div class="form-group victim-blessures-group"><label>Blessures (Ctrl pour s√©lection multiple)</label><div class="blessures-selected" id="blessuresSelected${index}"></div><div class="blessures-row"><select multiple size="5" id="blessures${index}" class="select-blessures"></select><div class="form-group" data-field="Autre blessure" style="flex-grow: 1;"><label style="margin-top: 0;">Autre blessure</label><input type="text" placeholder="Description libre..." class="blessure-autre-input"></div></div></div><div class="form-group" data-field="Infos compl√©mentaires" style="margin-top: 15px;"><label>Informations compl√©mentaires</label><textarea placeholder="Infos suppl√©mentaires..." rows="2" class="victim-infos-comp"></textarea></div>`;
    card.querySelector('.btn-remove-victim').addEventListener('click',function(){card.remove();});
    loadCirconstances();
    loadBlessures();
    const selectElement=card.querySelector(`#blessures${index}`);
    const selectedDivElement=card.querySelector(`#blessuresSelected${index}`);
    setupBlessuresSelect(selectElement,selectedDivElement);
    return card;
}

btnAddVictim.addEventListener('click',function(){victimCount++;const newCard=createVictimCard(victimCount);victimesContainer.appendChild(newCard);newCard.scrollIntoView({behavior:'smooth',block:'start'});});

function collectSectionData(sectionId){
    const section=document.getElementById(sectionId);
    const data={};
    if(!section)return data;
    
    if(sectionId==='sectionVictimes'){
        const victimsData=[];
        document.querySelectorAll('#victimesContainer .victim-card').forEach((card,index)=>{
            const vData={};
            const sexeVal = card.querySelector('.select-sexe')?.value;
            const ageVal = card.querySelector('.input-age')?.value;
            const circVal = card.querySelector('.select-circonstances')?.value;
            
            vData['Sexe']=sexeVal || 'NC';
            vData['√Çge']=ageVal || 'NC';
            vData['Circonstances']=circVal || 'NC';
            
            const blessuresSelect = card.querySelector('.select-blessures');
            const selectedBlessures = blessuresSelect ? Array.from(blessuresSelect.selectedOptions).map(opt=>opt.text).join(', ') : '';
            const autreBlessure=card.querySelector('.blessure-autre-input')?.value.trim() || '';
            
            let blessures=selectedBlessures;
            if(autreBlessure){
                if(blessures) {
                    blessures += ' (Autre: ' + autreBlessure + ')';
                } else {
                    blessures = autreBlessure;
                }
            }
            vData['Blessures']=blessures||'Inconnues';
            vData['Infos compl√©mentaires']=card.querySelector('.victim-infos-comp')?.value.trim()||'RAS';
            victimsData.push(vData);
        });
        data['Victimes']=victimsData;
        return data;
    }
    
    if(sectionId==='sectionMoyens'){
        const moyensEngages = [];
        if(document.getElementById('choucas05')?.checked) moyensEngages.push('CHOUCAS 05');
        if(document.getElementById('equipeTerrestre')?.checked) moyensEngages.push('√âquipe terrestre');
        if(document.getElementById('secoursMed')?.checked) moyensEngages.push('Secours m√©dicalis√©');
        if(moyensEngages.length > 0) data['Moyens'] = moyensEngages.join(', ');
        
        const meteoSelect = document.getElementById('meteo');
        if(meteoSelect) {
            const meteoValue = Array.from(meteoSelect.selectedOptions).map(opt=>opt.text).join(', ');
            if(meteoValue) data['M√©t√©o'] = meteoValue;
        }
        
        const obstaclesSelect = document.getElementById('obstacles');
        if(obstaclesSelect) {
            const obstaclesValue = Array.from(obstaclesSelect.selectedOptions).map(opt=>opt.text).join(', ');
            if(obstaclesValue) data['Obstacles'] = obstaclesValue;
        }
        
        const secouristesChecked = Array.from(document.querySelectorAll('#secouristesGrid input[type="checkbox"]:checked')).map(cb=>cb.value);
        if(secouristesChecked.length > 0) data['Secouristes'] = secouristesChecked.join(', ');
        
        const infosMoyens = document.getElementById('infosMoyens')?.value.trim();
        if(infosMoyens) data['Infos moyens'] = infosMoyens;
        
        
        const infosMoyensImportant = document.getElementById('infosMoyensImportant')?.checked || false;
        if(infosMoyensImportant){ data['Infos moyens important'] = true; }
    return data;
    }
    
    section.querySelectorAll('.form-group').forEach(group=>{
        const fieldName=group.getAttribute('data-field');
        if(!fieldName)return;
        let value='';
        const input=group.querySelector('input:not([type="radio"]):not([type="checkbox"]), select:not([multiple]):not(.country-code-select), textarea');
        if(input)value=input.value.trim();
        const radio=group.querySelector('input[type="radio"]:checked');
        if(radio)value=radio.value;
        const multipleSelect=group.querySelector('select[multiple]');
        if(multipleSelect)value=Array.from(multipleSelect.selectedOptions).map(opt=>opt.text).join(', ');
        const checkboxes=group.querySelectorAll('input[type="checkbox"]:checked');
        if(checkboxes.length>0&&!input&&!radio&&!multipleSelect){value=Array.from(checkboxes).map(cb=>cb.value).join(', ');}
        if(fieldName==="T√©l√©phones"){value=Array.from(document.querySelectorAll('#phonesContainer .phone-group')).map(group=>{const code=group.querySelector('.country-code-select').value;const num=group.querySelector('.phone-input').value.trim();const nom=group.querySelector('.phone-name-input').value.trim();return num?`${code} ${num}${nom?' ('+nom+')':''}`:'';}).filter(v=>v).join(' / ');}
        if(value)data[fieldName]=value;
    });
    
    if(sectionId==='sectionLocalisation'){
        const isGpsChecked=document.getElementById('geolocCheck').checked;
        const isAmlChecked=document.getElementById('amlCheck').checked;
        let gpsCoord='';
        const hasGpsData=document.getElementById('gpsLatD').value.trim()!==''&&document.getElementById('gpsLngD').value.trim()!=='';
        const hasAmlData=document.getElementById('amlLatD').value.trim()!==''&&document.getElementById('amlLngD').value.trim()!=='';
        if(isGpsChecked&&hasGpsData){gpsCoord+=`GPS: ${document.getElementById('gpsLatD').value}¬∞ ${document.getElementById('gpsLatM').value}' ${document.getElementById('gpsLatS').value}" / ${document.getElementById('gpsLngD').value}¬∞ ${document.getElementById('gpsLngM').value}' ${document.getElementById('gpsLngS').value}"`;}
        if(isAmlChecked&&hasAmlData){gpsCoord+=(gpsCoord?' - ':'')+`AML: ${document.getElementById('amlLatD').value}¬∞ ${document.getElementById('amlLatM').value}' ${document.getElementById('amlLatS').value}" / ${document.getElementById('amlLngD').value}¬∞ ${document.getElementById('amlLngM').value}' ${document.getElementById('amlLngS').value}"`;}
        if(gpsCoord)data['Coordonn√©es']=gpsCoord;
    }
    
    return data;
}

function formatMessage(data){
    const now = new Date();
    const timeStr = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    let message=`üö® ALERTE N¬∞${ALERT_NUMBER} - CRS BRIAN√áON - ${timeStr} üö®\n\n`;
    
    // --- Requ√©rant & Alerte ---
    if(data.Requ√©rant){
        message+=`===================================\nüë§ REQU√âRANT & ALERTE\n===================================\n`;
        message+=`* Origine: ${data.Requ√©rant["Origine de l'alerte"]||'NC'}\n`;
        message+=`* T√©l√©phone(s): ${data.Requ√©rant['T√©l√©phones']||'NC'}\n`;
        
        message+=`* Activit√©: ${data.Requ√©rant['Activit√©']||'NC'}\n`;
        if(data.Requ√©rant['Infos requ√©rant']){message+=`* Infos Requ√©r.: ${data.Requ√©rant['Infos requ√©rant']}\n`;}
        message+=`\n`;
    }
    
    // --- Localisation ---
    if(data.Localisation){
        message+=`===================================\nüìç LOCALISATION\n===================================\n`;
        message+=`* Commune: *${data.Localisation['Commune']||'NC'}* (${data.Localisation['D√©partement']||'05'})\n`;
        message+=`* Altitude: ${data.Localisation['Altitude']?data.Localisation['Altitude']+'m':'NC'}\n`;
        message+=`* Lieu Exact: ${data.Localisation['Lieu exact (ou coller contenu goute Gendloc)']||'NC'}\n`;
        if(data.Localisation['Coordonn√©es']){message+=`* Coordonn√©es: ${data.Localisation['Coordonn√©es']}\n`;}
        message+=`\n`;
    }
    
    // --- Victimes ---
    if(data.Victime && data.Victime.Victimes && data.Victime.Victimes.length>0){
        message+=`===================================\nüöë VICTIMES (${data.Victime.Victimes.length})\n===================================\n`;
        data.Victime.Victimes.forEach((v,i)=>{
            message+=`* *Victime ${i+1}:*\n`;
            message+=`  - S/A/C: ${v.Sexe} / ${v.√Çge} ans / ${v.Circonstances}\n`;
            message+=`  - Blessures: *${v.Blessures}*\n`;
            if(v['Infos compl√©mentaires']!=='RAS'){message+=`  - Infos Comp.: ${v['Infos compl√©mentaires']}\n`;}
        });
        message+=`\n`;
    }
    
    // --- Moyens & Conditions (avec v√©rification claire) ---
    if(data['Moyens engag√©s']){ // Utiliser la cl√© correcte issue du collecteur
        const moyensData = data['Moyens engag√©s']; 
        
        message+=`===================================\nüöÅ MOYENS & CONDITIONS\n===================================\n`;
        
        // Affichage des moyens de mani√®re claire (comme demand√©)
        // Note: moyensData.Moyens contient une cha√Æne comme 'CHOUCAS 05, √âquipe terrestre'
        const choucasChecked = moyensData.Moyens?.includes('CHOUCAS 05') ? 'OUI ‚úÖ' : 'NON ‚ùå';
        const terrestreChecked = moyensData.Moyens?.includes('√âquipe terrestre') ? 'OUI ‚úÖ' : 'NON ‚ùå';
        const medChecked = moyensData.Moyens?.includes('Secours m√©dicalis√©') ? 'OUI ‚úÖ' : 'NON ‚ùå';
        
        message+=`* **CHOUCAS 05:** ${choucasChecked}\n`;
        message+=`* **√âquipe Terrestre:** ${terrestreChecked}\n`;
        message+=`* **Secours M√©dicalis√©:** ${medChecked}\n`;
        
        message+=`* M√©t√©o: ${moyensData['M√©t√©o']||'NC'}\n`;
        message+=`* Obstacles: ${moyensData['Obstacles']||'Aucun'}\n`;
        if(moyensData['Secouristes']){message+=`* Secouristes Engag√©s: ${moyensData['Secouristes']}\n`;}
        if(moyensData['Infos moyens']){ if(moyensData['Infos moyens important']){  message+=`* ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ${moyensData['Infos moyens']} ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
`; } else {  message+=`* Infos Comp.: ${moyensData['Infos moyens']}
`; }}
        message+=`\n`;
    }
    return message.trim();
}

function showCopyConfirmation(){const conf=document.getElementById('copyConfirmation');conf.style.opacity=1;setTimeout(()=>{conf.style.opacity=0;},2000);}

document.querySelectorAll('.btn-copy').forEach(btn=>{
    btn.addEventListener('click',async function(){
        const sectionId=this.getAttribute('data-section');
        const data={};
        const sections=['sectionRequerant','sectionLocalisation','sectionVictimes','sectionMoyens'];
        
        for(let i=0;i<sections.length;i++){
            const sId=sections[i];
            // Utilise l'attribut data-section-name de la balise section
            const sectionName=document.getElementById(sId).getAttribute('data-section-name');
            
            // 1. Collecter les donn√©es de la section
            // 'Victime(s)' est le seul nom de section qui est trait√© diff√©remment (data.Victime)
            if(sId==='sectionVictimes'){
                data.Victime=collectSectionData(sId);
            } else {
                // Pour toutes les autres, utilise le sectionName comme cl√© (ex: data['Moyens engag√©s'])
                data[sectionName]=collectSectionData(sId);
            }

            // 2. Si c'est le bouton de cette section, on s'arr√™te APR√àS avoir collect√© ses donn√©es
            if(sId===sectionId)break; 
        }
        
        const message=formatMessage(data);
        try{await navigator.clipboard.writeText(message);showCopyConfirmation();}catch(err){console.error('Erreur:',err);prompt(`‚ö†Ô∏è Copier manuellement :`,message);}
    });
});

document.getElementById('btnSave').addEventListener('click',saveIntervention);
document.getElementById('btnCancel').addEventListener('click',function(){
    if(confirm('√ätes-vous s√ªr de vouloir annuler ? Toutes les donn√©es non sauvegard√©es seront perdues.')){
        // Fermer l'onglet via le parent
        sendToParent('CLOSE_TAB', {
            tabId: currentTabId
        });
    }
});
    </script>
<script>
// --- D√©partement: gestion "Autre‚Ä¶" ---
(function(){
  const sel = document.getElementById('departement');
  const wrap = document.getElementById('departementAutreWrap');
  if(!sel || !wrap) return;
  function ensureAutreInput(){
    let autre = document.getElementById('departementAutre');
    if(sel.value === 'autre'){
      if(!autre){
        autre = document.createElement('input');
        autre.type = 'text';
        autre.id = 'departementAutre';
        autre.inputMode = 'numeric';
        autre.pattern = '\\d{2,3}';
        autre.maxLength = 3;
        autre.placeholder = 'Saisir n¬∞ de d√©partement (ex: 13)';
        autre.className = 'input';
        autre.style.marginTop = '8px';
        wrap.appendChild(autre);
        autre.focus();
      }
    } else {
      if(autre){ wrap.removeChild(autre); }
    }
  }
  sel.addEventListener('change', ensureAutreInput);
  // init on load
  ensureAutreInput();
})();
</script>
</body>
</html>